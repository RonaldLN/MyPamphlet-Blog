<!doctype html><html class=no-js lang=zh><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=../../../04/29/llama-3/ rel=prev><link href=../../04/aiapi/ rel=next><link href=../../../../icons/favicon.png rel=icon><meta content="mkdocs-1.5.3, mkdocs-material-9.4.6" name=generator><title>24数模校赛记录 - My Pamphlet Blog</title><link href=../../../../assets/stylesheets/main.35e1ed30.min.css rel=stylesheet><link href=../../../../assets/stylesheets/palette.356b1318.min.css rel=stylesheet><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback" rel=stylesheet><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link href=../../../../css/timeago.css rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-web/style.css rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel=stylesheet><link href=../../../../stylesheets/my_scheme.css rel=stylesheet><link href=../../../../stylesheets/custom.css rel=stylesheet><link href=../../../../stylesheets/card.css rel=stylesheet><script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-H7SV12D750"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-H7SV12D750",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-H7SV12D750",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><script>var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?7a9cfe470ed52fa0c0940a58fede385c";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();</script><link href=../../../../assets/stylesheets/glightbox.min.css rel=stylesheet><style>html.glightbox-open{overflow:initial;height:100%}.gslide-title{user-select:text;margin-top:0}.gslide-desc{color:#666;user-select:text}.gslide-image img{background:#fff}.gscrollbar-fixer{padding-right:15px}.gdesc-inner{font-size:.75rem}body[data-md-color-scheme=slate] .gdesc-inner{background:var(--md-default-bg-color)}body[data-md-color-scheme=slate] .gslide-title,body[data-md-color-scheme=slate] .gslide-desc{color:var(--md-default-fg-color)}</style><script src=../../../../assets/javascripts/glightbox.min.js></script><body data-md-color-accent=indigo data-md-color-primary=indigo data-md-color-scheme=sunset-glow dir=ltr><script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script><input autocomplete=off class=md-toggle data-md-toggle=drawer id=__drawer type=checkbox><input autocomplete=off class=md-toggle data-md-toggle=search id=__search type=checkbox><label class=md-overlay for=__drawer></label><div data-md-component=skip><a class=md-skip href=#24> 跳转至 </a></div><div data-md-component=announce></div><header class=md-header data-md-component=header><nav class="md-header__inner md-grid" aria-label=页眉><a aria-label="My Pamphlet Blog" class="md-header__button md-logo" title="My Pamphlet Blog" data-md-component=logo href=../../../..> <svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><path d="M96 0C43 0 0 43 0 96v320c0 53 43 96 96 96h320c17.7 0 32-14.3 32-32s-14.3-32-32-32v-64c17.7 0 32-14.3 32-32V32c0-17.7-14.3-32-32-32H96zm0 384h256v64H96c-17.7 0-32-14.3-32-32s14.3-32 32-32zm32-240c0-8.8 7.2-16 16-16h192c8.8 0 16 7.2 16 16s-7.2 16-16 16H144c-8.8 0-16-7.2-16-16zm16 48h192c8.8 0 16 7.2 16 16s-7.2 16-16 16H144c-8.8 0-16-7.2-16-16s7.2-16 16-16z"/></svg> </a><label class="md-header__button md-icon" for=__drawer><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg></label><div class=md-header__title data-md-component=header-title><div class=md-header__ellipsis><div class=md-header__topic><span class=md-ellipsis> My Pamphlet Blog </span></div><div class=md-header__topic data-md-component=header-topic><span class=md-ellipsis> 24数模校赛记录 </span></div></div></div><form class=md-header__option data-md-component=palette><input aria-label="Switch to dark mode" data-md-color-media="(prefers-color-scheme: light)" class=md-option data-md-color-accent=indigo data-md-color-primary=indigo data-md-color-scheme=sunset-glow id=__palette_1 name=__palette type=radio><label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg></label><input aria-label="Switch to light mode" data-md-color-media="(prefers-color-scheme: dark)" class=md-option data-md-color-accent=indigo data-md-color-primary=indigo data-md-color-scheme=sunset-glow-dark id=__palette_2 name=__palette type=radio><label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg></label></form><label class="md-header__button md-icon" for=__search><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg></label><div class=md-search data-md-component=search role=dialog><label class=md-search__overlay for=__search></label><div class=md-search__inner role=search><form class=md-search__form name=search><input aria-label=搜索 autocapitalize=off autocomplete=off autocorrect=off class=md-search__input data-md-component=search-query name=query placeholder=搜索 required spellcheck=false type=text><label class="md-search__icon md-icon" for=__search><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg></label><nav aria-label=查找 class=md-search__options><a class="md-search__icon md-icon" aria-label=分享 data-clipboard data-clipboard-text data-md-component=search-share href=javascript:void(0) tabindex=-1 title=分享> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a><button class="md-search__icon md-icon" aria-label=清空当前内容 tabindex=-1 title=清空当前内容 type=reset><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg></button></nav><div class=md-search__suggest data-md-component=search-suggest></div></form><div class=md-search__output><div class=md-search__scrollwrap data-md-scrollfix><div class=md-search-result data-md-component=search-result><div class=md-search-result__meta>正在初始化搜索引擎</div><ol class=md-search-result__list role=presentation></ol></div></div></div></div></div><div class=md-header__source><a class=md-source data-md-component=source href=https://github.com/RonaldLN/MyPamphlet-Blog title=前往仓库> <div class="md-source__icon md-icon"><svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg></div> <div class=md-source__repository>RonaldLN/MyPamphlet-Blog</div> </a></div></nav></header><div class=md-container data-md-component=container><nav aria-label=标签 class=md-tabs data-md-component=tabs><div class=md-grid><ul class=md-tabs__list><li class="md-tabs__item md-tabs__item--active"><a class=md-tabs__link href=../../../..> Blog </a></ul></div></nav><main class=md-main data-md-component=main><div class="md-main__inner md-grid"><div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation hidden><div class=md-sidebar__scrollwrap><div class=md-sidebar__inner><nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0><label class=md-nav__title for=__drawer><a aria-label="My Pamphlet Blog" class="md-nav__button md-logo" title="My Pamphlet Blog" data-md-component=logo href=../../../..> <svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><path d="M96 0C43 0 0 43 0 96v320c0 53 43 96 96 96h320c17.7 0 32-14.3 32-32s-14.3-32-32-32v-64c17.7 0 32-14.3 32-32V32c0-17.7-14.3-32-32-32H96zm0 384h256v64H96c-17.7 0-32-14.3-32-32s14.3-32 32-32zm32-240c0-8.8 7.2-16 16-16h192c8.8 0 16 7.2 16 16s-7.2 16-16 16H144c-8.8 0-16-7.2-16-16zm16 48h192c8.8 0 16 7.2 16 16s-7.2 16-16 16H144c-8.8 0-16-7.2-16-16s7.2-16 16-16z"/></svg> </a> My Pamphlet Blog</label><div class=md-nav__source><a class=md-source data-md-component=source href=https://github.com/RonaldLN/MyPamphlet-Blog title=前往仓库> <div class="md-source__icon md-icon"><svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg></div> <div class=md-source__repository>RonaldLN/MyPamphlet-Blog</div> </a></div><ul class=md-nav__list data-md-scrollfix><li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle" checked id=__nav_1 type=checkbox> <label class=md-nav__link for=__nav_1 id=__nav_1_label><span class=md-ellipsis> Blog </span> <span class="md-nav__icon md-icon"></span></label> <nav aria-expanded=true aria-labelledby=__nav_1_label class=md-nav data-md-level=1><label class=md-nav__title for=__nav_1><span class="md-nav__icon md-icon"></span> Blog</label><ul class=md-nav__list data-md-scrollfix><li class="md-nav__item md-nav__item--active"><a class=md-nav__link href=../../../..> <span class=md-ellipsis> Blog </span> </a><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" id=__nav_1_2 type=checkbox> <label class=md-nav__link for=__nav_1_2 id=__nav_1_2_label tabindex=0><span class=md-ellipsis> 归档 </span> <span class="md-nav__icon md-icon"></span></label> <nav aria-expanded=false aria-labelledby=__nav_1_2_label class=md-nav data-md-level=2><label class=md-nav__title for=__nav_1_2><span class="md-nav__icon md-icon"></span> 归档</label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a class=md-nav__link href=../../../../archive/2025/> <span class=md-ellipsis> 2025 </span> </a><li class=md-nav__item><a class=md-nav__link href=../../../../archive/2024/> <span class=md-ellipsis> 2024 </span> </a><li class=md-nav__item><a class=md-nav__link href=../../../../archive/2023/> <span class=md-ellipsis> 2023 </span> </a></ul></nav><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" id=__nav_1_3 type=checkbox> <label class=md-nav__link for=__nav_1_3 id=__nav_1_3_label tabindex=0><span class=md-ellipsis> 分类 </span> <span class="md-nav__icon md-icon"></span></label> <nav aria-expanded=false aria-labelledby=__nav_1_3_label class=md-nav data-md-level=2><label class=md-nav__title for=__nav_1_3><span class="md-nav__icon md-icon"></span> 分类</label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a class=md-nav__link href=../../../../category/records-of-trivia/> <span class=md-ellipsis> Records of Trivia </span> </a><li class=md-nav__item><a class=md-nav__link href=../../../../category/configure-debug/> <span class=md-ellipsis> Configure & Debug </span> </a><li class=md-nav__item><a class=md-nav__link href=../../../../category/chronicle-of-events/> <span class=md-ellipsis> Chronicle of Events </span> </a></ul></nav></ul></nav></ul></nav></div></div></div><div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc><div class=md-sidebar__scrollwrap><div class=md-sidebar__inner><nav class="md-nav md-nav--secondary" aria-label=目录><label class=md-nav__title for=__toc><span class="md-nav__icon md-icon"></span> 目录</label><ul class=md-nav__list data-md-component=toc data-md-scrollfix><li class=md-nav__item><a class=md-nav__link href=#_1> 寻找分析神经网络模型特征的方法 </a><li class=md-nav__item><a class=md-nav__link href=#_2> 处理数据和训练 </a><li class=md-nav__item><a class=md-nav__link href=#shap> 尝试使用SHAP值对模型进行分析 </a><li class=md-nav__item><a class=md-nav__link href=#xgboostshap> 使用XGBoost模型进行训练，并计算SHAP值 </a></ul></nav></div></div></div><script defer src=https://cdn.jsdelivr.net/gh/RonaldLN/MyPamphlet-Blog@main/docs/javascripts/toc.js></script><link href=https://cdn.jsdelivr.net/gh/RonaldLN/MyPamphlet-Blog@main/docs/stylesheets/fold_toc.css rel=stylesheet><div class="md-content md-content--post" data-md-component=content><div class="md-sidebar md-sidebar--post" data-md-component=sidebar data-md-type=navigation><div class=md-sidebar__scrollwrap><div class="md-sidebar__inner md-post"><nav class="md-nav md-nav--primary"><div class=md-post__back><div class="md-nav__title md-nav__container"><a class=md-nav__link href=../../../..> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> <span class=md-ellipsis> 回到主页 </span> </a></div></div><div class="md-post__authors md-typeset"><div class="md-profile md-post__profile"><span class="md-author md-author--long"> <img alt="Ronald Luo" src="https://avatars.githubusercontent.com/u/120019179?v=4"> </span><span class=md-profile__description> <strong>Ronald Luo</strong><br> I'm A Student </span></div></div><ul class="md-post__meta md-nav__list"><li class="md-nav__item md-nav__item--section"><div class=md-post__title><span class=md-ellipsis> 元数据 </span></div> <nav class=md-nav><ul class=md-nav__list><li class=md-nav__item><div class=md-nav__link><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5v-5Z"/></svg><time datetime="2024-05-01 00:00:00" class=md-ellipsis>2024年5月1日星期三</time></div><li class=md-nav__item><div class=md-nav__link><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M9 3v15h3V3H9m3 2 4 13 3-1-4-13-3 1M5 5v13h3V5H5M3 19v2h18v-2H3Z"/></svg><span class=md-ellipsis> 分类于 <a href=../../../../category/chronicle-of-events/>Chronicle of Events</a></span></div><li class=md-nav__item><div class=md-nav__link><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7h1.5Z"/></svg><span class=md-ellipsis> 需要 17 分钟阅读时间 </span></div></ul></nav></ul></nav></div></div></div><article class="md-content__inner md-typeset"><h1 id=24>24数模校赛记录<a title="Permanent link" class=headerlink href=#24>¶</a></h1><div style=opacity:.7;margin-top:-15px;font-size:.75em><p><span class=twemoji><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8V2m6.78 1a.69.69 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38-2.5-2.5Z"/></svg></span> 约 5907 个字 • <span class=twemoji><svg viewbox="0 0 640 512" xmlns=http://www.w3.org/2000/svg><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6zm80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3z"/></svg></span> 595 行代码</div><p>(A题)题目分别给出了正常人、早期和晚期癌症患者的基因表达数据(一个数值)，然后大概需要分析出能够辨别癌症状态的特征基因，<p>而我觉得这题能可以使用神经网络来操作，所以就打算选这题尝试<blockquote><p>另一方面也因为，B题是<em>基于负面影响最小的任务分配问题</em>，感觉没有太多可以操作的空间</blockquote><h2 id=_1>寻找分析神经网络模型特征的方法<a title="Permanent link" class=headerlink href=#_1>¶</a></h2><p>我的想法是使用MLP来训练数据，但由于这题最后需要找出特征，而之前不太清楚要如何由已训练好的模型找到特征，所以搜寻信息<details class=example open><summary>对话记录</summary> <p>你:</p> <p>How to extract feature dimensions from DNN models?</p> <p> </p> <p>Bing:</p> <p>要通过深度学习来确定数据中哪些维度是重要的，可以采用以下方法：</p> <ol><li><a href=https://www.zhihu.com/question/310837513><strong>特征重要性评估</strong>：使用类似于XGBoost模型中的特征重要性计算方法。在深度神经网络（DNN）中，可以通过观察模型中每个特征的变化对模型性能的影响来评估特征的重要性。例如，可以通过随机打乱每个特征的值并重新评估模型性能来实现。如果性能下降显著，则该特征可能很重要</a> <a href=https://www.zhihu.com/question/310837513><code>¹</code></a> <a href=https://blog.csdn.net/fengdu78/article/details/120735471><code>²</code></a>。<li><a href=https://www.zhihu.com/question/310837513><strong>Shapley值</strong>：Shapley值是一种博弈论中的概念，用于量化每个玩家（在这里是特征）对游戏（模型的预测）的贡献。在深度学习中，可以使用Shapley值来估计每个特征对模型预测的贡献</a> <a href=https://www.zhihu.com/question/310837513><code>¹</code></a>。<li><strong>正则化技术</strong>：使用L1正则化可以帮助进行特征选择，因为它倾向于产生稀疏权重矩阵。在训练过程中，不重要的特征的权重会趋近于零。<li><strong>注意力机制</strong>：在深度学习模型中，特别是在序列模型如RNN中，注意力机制可以用来识别对预测结果最有影响的输入部分。<li><strong>模型可解释性工具</strong>：使用模型可解释性工具，如LIME或SHAP，可以帮助解释模型的预测，并指出哪些特征对预测结果有最大影响。</ol> <p>通过这些方法，你可以识别出对模型预测最有影响的特征，即数据中的重要维度。这些方法可以单独使用，也可以结合使用，以获得更全面的特征重要性评估。</p> <p>了解详细信息 <a href=https://www.zhihu.com/question/310837513><code>1 | zhihu.com</code></a> <a href=https://blog.csdn.net/fengdu78/article/details/120735471><code>2 | blog.csdn.net</code></a> <a href=https://zhuanlan.zhihu.com/p/395560780><code>3 | zhuanlan.zhihu.com</code></a> <a href="https://bing.com/search?q=深度学习+如何获取数据重要维度"><code>4 | bing.com</code></a> <a href=https://zhuanlan.zhihu.com/p/655633788><code>5 | zhuanlan.zhihu.com</code></a></p></details><p>查看了Bing提到的知乎上一个问题的回答，注意到这个回答提到了<strong><mark>Shapley值</mark></strong><p><a href=https://www.zhihu.com/question/310837513/answer/1281609735>使用DNN训练神经网络模型时，如何知道每个特征的重要性（像xgboost模型能计算出特征重要性一样）？ - 王睿的回答 - 知乎</a><p>而然后重新使用英文询问Bing，<strong>也提到了Shapley值</strong><details class=example open><summary>对话记录</summary> <p>你:</p> <p>How to extract feature dimensions from DNN models?</p> <p> </p> <p>Bing:</p> <p>To extract feature dimensions from Deep Neural Network (DNN) models, you typically follow these steps:</p> <ol><li><strong>Choose the layer</strong> from which you want to extract features. This is often a layer towards the end of the network, just before the fully connected layers, as it captures high-level features.<li><strong>Pass your input data</strong> through the network up to the chosen layer. You can do this by modifying the network architecture to output the desired layer’s activations.<li><strong>Collect the output</strong> of that layer, which will be the features. The shape of this output will give you the feature dimensions.</ol> <p>For example, in Keras, you can use the <code>Model</code> class to create a new model that outputs the features from a specific layer:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-0-1><a href=#__codelineno-0-1 id=__codelineno-0-1 name=__codelineno-0-1></a><span class=kn>from</span><span class=w> </span><span class=nn>keras.models</span><span class=w> </span><span class=kn>import</span> <span class=n>Model</span>
</span><span id=__span-0-2><a href=#__codelineno-0-2 id=__codelineno-0-2 name=__codelineno-0-2></a>
</span><span id=__span-0-3><a href=#__codelineno-0-3 id=__codelineno-0-3 name=__codelineno-0-3></a><span class=c1># Assume 'base_model' is your pre-trained DNN model</span>
</span><span id=__span-0-4><a href=#__codelineno-0-4 id=__codelineno-0-4 name=__codelineno-0-4></a><span class=c1># and 'layer_name' is the name of the layer from which you want to extract features.</span>
</span><span id=__span-0-5><a href=#__codelineno-0-5 id=__codelineno-0-5 name=__codelineno-0-5></a>
</span><span id=__span-0-6><a href=#__codelineno-0-6 id=__codelineno-0-6 name=__codelineno-0-6></a><span class=n>model</span> <span class=o>=</span> <span class=n>Model</span><span class=p>(</span><span class=n>inputs</span><span class=o>=</span><span class=n>base_model</span><span class=o>.</span><span class=n>input</span><span class=p>,</span> <span class=n>outputs</span><span class=o>=</span><span class=n>base_model</span><span class=o>.</span><span class=n>get_layer</span><span class=p>(</span><span class=n>layer_name</span><span class=p>)</span><span class=o>.</span><span class=n>output</span><span class=p>)</span>
</span><span id=__span-0-7><a href=#__codelineno-0-7 id=__codelineno-0-7 name=__codelineno-0-7></a>
</span><span id=__span-0-8><a href=#__codelineno-0-8 id=__codelineno-0-8 name=__codelineno-0-8></a><span class=c1># Now you can use this model to predict and extract features</span>
</span><span id=__span-0-9><a href=#__codelineno-0-9 id=__codelineno-0-9 name=__codelineno-0-9></a><span class=n>features</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>your_data</span><span class=p>)</span>
</span></code></pre></div> <p>The <code>features</code> variable will now contain the output of the layer specified, and the shape of this array will give you the feature dimensions.</p> <p>For large datasets that don’t fit into memory, you can use <strong>incremental learning</strong>. <a href=https://pyimagesearch.com/2019/05/27/keras-feature-extraction-on-large-datasets-with-deep-learning/>This involves extracting features in batches and possibly storing them on disk before training a classifier on top of these features</a> <a href=https://pyimagesearch.com/2019/05/27/keras-feature-extraction-on-large-datasets-with-deep-learning/><code>¹</code></a>.</p> <p><a href=https://medium.com/@leicao.me/how-deep-learning-neural-networks-extracts-features-277244bcf66e>If you’re working with Convolutional Neural Networks (CNNs), the filters in the convolutional layers act as feature extractors, capturing patterns such as edges and textures in the initial layers, and more complex features in deeper layers</a> <a href=https://medium.com/@leicao.me/how-deep-learning-neural-networks-extracts-features-277244bcf66e><code>²</code></a>.</p> <p>Remember, the exact method may vary depending on the framework you’re using and the specific architecture of your DNN model. The provided example is a general approach and might need adjustments based on your setup.</p> <p>了解详细信息 <a href=https://pyimagesearch.com/2019/05/27/keras-feature-extraction-on-large-datasets-with-deep-learning/><code>1 | pyimagesearch.com</code></a> <a href=https://medium.com/@leicao.me/how-deep-learning-neural-networks-extracts-features-277244bcf66e><code>2 | medium.com</code></a> <a href=https://stats.stackexchange.com/questions/473667/feature-extraction-in-deep-neural-networks><code>3 | stats.stackexchange.com</code></a> <a href=https://stackoverflow.com/questions/69298074/how-to-extract-features-from-a-cnn-model-using-its-actuall-weights-after-trainin><code>4 | stackoverflow.com</code></a> <a href=https://www.nature.com/articles/s41598-018-34833-6.pdf><code>5 | nature.com</code></a></p> <p> </p> <p>你:</p> <p>For example, I have a dataset with 10 dimensions each, which can be used to classify the data into one of three categories. How can I determine which dimension has the greatest impact on classification (using deep neural networks)</p> <p> </p> <p>Bing:</p> <p>To determine which dimension has the greatest impact on classification using deep neural networks, you can use techniques such as <strong>permutation importance</strong> or <strong>SHAP (SHapley Additive exPlanations)</strong> values. Here’s a brief overview of each method:</p> <p><big><strong>Permutation Importance</strong></big></p> <p>Permutation importance is a model inspection technique that can be used for any fitted estimator when the data is tabular. This method involves shuffling individual feature columns and observing the impact on the model’s accuracy. <a href=https://stackoverflow.com/questions/45361559/feature-importance-chart-in-neural-network-using-keras-in-python>The idea is that the features that are important to the model’s predictions will show a significant decrease in model performance when they are shuffled</a> <a href=https://stackoverflow.com/questions/45361559/feature-importance-chart-in-neural-network-using-keras-in-python><code>¹</code></a>.</p> <p>Here’s how you can implement permutation importance using Python with Keras:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-1-1><a href=#__codelineno-1-1 id=__codelineno-1-1 name=__codelineno-1-1></a><span class=kn>from</span><span class=w> </span><span class=nn>keras.wrappers.scikit_learn</span><span class=w> </span><span class=kn>import</span> <span class=n>KerasClassifier</span><span class=p>,</span> <span class=n>KerasRegressor</span>
</span><span id=__span-1-2><a href=#__codelineno-1-2 id=__codelineno-1-2 name=__codelineno-1-2></a><span class=kn>import</span><span class=w> </span><span class=nn>eli5</span>
</span><span id=__span-1-3><a href=#__codelineno-1-3 id=__codelineno-1-3 name=__codelineno-1-3></a><span class=kn>from</span><span class=w> </span><span class=nn>eli5.sklearn</span><span class=w> </span><span class=kn>import</span> <span class=n>PermutationImportance</span>
</span><span id=__span-1-4><a href=#__codelineno-1-4 id=__codelineno-1-4 name=__codelineno-1-4></a>
</span><span id=__span-1-5><a href=#__codelineno-1-5 id=__codelineno-1-5 name=__codelineno-1-5></a><span class=c1># Define your model</span>
</span><span id=__span-1-6><a href=#__codelineno-1-6 id=__codelineno-1-6 name=__codelineno-1-6></a><span class=k>def</span><span class=w> </span><span class=nf>base_model</span><span class=p>():</span>
</span><span id=__span-1-7><a href=#__codelineno-1-7 id=__codelineno-1-7 name=__codelineno-1-7></a>    <span class=n>model</span> <span class=o>=</span> <span class=n>Sequential</span><span class=p>()</span>
</span><span id=__span-1-8><a href=#__codelineno-1-8 id=__codelineno-1-8 name=__codelineno-1-8></a>    <span class=n>model</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>Dense</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=n>input_dim</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s1>'relu'</span><span class=p>))</span>
</span><span id=__span-1-9><a href=#__codelineno-1-9 id=__codelineno-1-9 name=__codelineno-1-9></a>    <span class=n>model</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>Dense</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s1>'softmax'</span><span class=p>))</span>  <span class=c1># Assuming 3 categories</span>
</span><span id=__span-1-10><a href=#__codelineno-1-10 id=__codelineno-1-10 name=__codelineno-1-10></a>    <span class=n>model</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span><span class=n>loss</span><span class=o>=</span><span class=s1>'categorical_crossentropy'</span><span class=p>,</span> <span class=n>optimizer</span><span class=o>=</span><span class=s1>'adam'</span><span class=p>)</span>
</span><span id=__span-1-11><a href=#__codelineno-1-11 id=__codelineno-1-11 name=__codelineno-1-11></a>    <span class=k>return</span> <span class=n>model</span>
</span><span id=__span-1-12><a href=#__codelineno-1-12 id=__codelineno-1-12 name=__codelineno-1-12></a>
</span><span id=__span-1-13><a href=#__codelineno-1-13 id=__codelineno-1-13 name=__codelineno-1-13></a><span class=c1># Fit your model</span>
</span><span id=__span-1-14><a href=#__codelineno-1-14 id=__codelineno-1-14 name=__codelineno-1-14></a><span class=n>X</span> <span class=o>=</span> <span class=o>...</span>  <span class=c1># Your input features</span>
</span><span id=__span-1-15><a href=#__codelineno-1-15 id=__codelineno-1-15 name=__codelineno-1-15></a><span class=n>y</span> <span class=o>=</span> <span class=o>...</span>  <span class=c1># Your target labels</span>
</span><span id=__span-1-16><a href=#__codelineno-1-16 id=__codelineno-1-16 name=__codelineno-1-16></a><span class=n>my_model</span> <span class=o>=</span> <span class=n>KerasRegressor</span><span class=p>(</span><span class=n>build_fn</span><span class=o>=</span><span class=n>base_model</span><span class=p>,</span> <span class=n>epochs</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>batch_size</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>verbose</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-1-17><a href=#__codelineno-1-17 id=__codelineno-1-17 name=__codelineno-1-17></a><span class=n>my_model</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span><span id=__span-1-18><a href=#__codelineno-1-18 id=__codelineno-1-18 name=__codelineno-1-18></a>
</span><span id=__span-1-19><a href=#__codelineno-1-19 id=__codelineno-1-19 name=__codelineno-1-19></a><span class=c1># Calculate permutation importance</span>
</span><span id=__span-1-20><a href=#__codelineno-1-20 id=__codelineno-1-20 name=__codelineno-1-20></a><span class=n>perm</span> <span class=o>=</span> <span class=n>PermutationImportance</span><span class=p>(</span><span class=n>my_model</span><span class=p>,</span> <span class=n>random_state</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span><span id=__span-1-21><a href=#__codelineno-1-21 id=__codelineno-1-21 name=__codelineno-1-21></a><span class=n>eli5</span><span class=o>.</span><span class=n>show_weights</span><span class=p>(</span><span class=n>perm</span><span class=p>,</span> <span class=n>feature_names</span><span class=o>=</span><span class=p>[</span><span class=s1>'Feature 1'</span><span class=p>,</span> <span class=s1>'Feature 2'</span><span class=p>,</span> <span class=o>...</span><span class=p>,</span> <span class=s1>'Feature 10'</span><span class=p>])</span>
</span></code></pre></div> <p><big><strong>SHAP Values</strong></big></p> <p>SHAP values provide a way to understand the contribution of each feature to the model’s predictions. <a href=https://aitechtrend.com/a-guide-to-explaining-feature-importance-in-neural-networks-using-shap/>It is based on game theory and calculates the contribution of each feature to the prediction of each instance in comparison to the average prediction for the dataset</a> <a href=https://aitechtrend.com/a-guide-to-explaining-feature-importance-in-neural-networks-using-shap/><code>²</code></a>.</p> <p>Here’s a simple example of how to use SHAP with a neural network:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-2-1><a href=#__codelineno-2-1 id=__codelineno-2-1 name=__codelineno-2-1></a><span class=kn>import</span><span class=w> </span><span class=nn>shap</span>
</span><span id=__span-2-2><a href=#__codelineno-2-2 id=__codelineno-2-2 name=__codelineno-2-2></a>
</span><span id=__span-2-3><a href=#__codelineno-2-3 id=__codelineno-2-3 name=__codelineno-2-3></a><span class=c1># Assume 'model' is your trained Keras model and 'X' is your input data</span>
</span><span id=__span-2-4><a href=#__codelineno-2-4 id=__codelineno-2-4 name=__codelineno-2-4></a>
</span><span id=__span-2-5><a href=#__codelineno-2-5 id=__codelineno-2-5 name=__codelineno-2-5></a><span class=c1># Explain predictions using SHAP</span>
</span><span id=__span-2-6><a href=#__codelineno-2-6 id=__codelineno-2-6 name=__codelineno-2-6></a><span class=n>explainer</span> <span class=o>=</span> <span class=n>shap</span><span class=o>.</span><span class=n>DeepExplainer</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>X</span><span class=p>)</span>
</span><span id=__span-2-7><a href=#__codelineno-2-7 id=__codelineno-2-7 name=__codelineno-2-7></a><span class=n>shap_values</span> <span class=o>=</span> <span class=n>explainer</span><span class=o>.</span><span class=n>shap_values</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span><span id=__span-2-8><a href=#__codelineno-2-8 id=__codelineno-2-8 name=__codelineno-2-8></a>
</span><span id=__span-2-9><a href=#__codelineno-2-9 id=__codelineno-2-9 name=__codelineno-2-9></a><span class=c1># Plot the SHAP values for the first instance</span>
</span><span id=__span-2-10><a href=#__codelineno-2-10 id=__codelineno-2-10 name=__codelineno-2-10></a><span class=n>shap</span><span class=o>.</span><span class=n>initjs</span><span class=p>()</span>
</span><span id=__span-2-11><a href=#__codelineno-2-11 id=__codelineno-2-11 name=__codelineno-2-11></a><span class=n>shap</span><span class=o>.</span><span class=n>force_plot</span><span class=p>(</span><span class=n>explainer</span><span class=o>.</span><span class=n>expected_value</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>shap_values</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span> <span class=n>X</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></code></pre></div> <p>Both methods can give you insights into which dimensions (features) are most important for your deep neural network’s classification decisions. Remember to carefully interpret the results, as the importance of features can depend on the model and the specific data you are working with.</p> <p>了解详细信息 <a href=https://stackoverflow.com/questions/45361559/feature-importance-chart-in-neural-network-using-keras-in-python><code>1 | stackoverflow.com</code></a> <a href=https://aitechtrend.com/a-guide-to-explaining-feature-importance-in-neural-networks-using-shap/><code>2 | aitechtrend.com</code></a> <a href=https://machinelearningmastery.com/calculate-feature-importance-with-python/><code>3 | machinelearningmastery.com</code></a> <a href=https://datascience.stackexchange.com/questions/44644/how-to-determine-feature-importance-in-a-neural-network><code>4 | datascience.stackexchange.com</code></a> <a href=https://stats.stackexchange.com/questions/261008/deep-learning-how-do-i-know-which-variables-are-important><code>5 | stats.stackexchange.com</code></a></p></details><p>于是打算尝试这个方法，<p>但由于Bing给出的代码中，应该是需要训练好模型之后再对模型进行分析，于是就开始编写python代码处理数据并训练模型<h2 id=_2>处理数据和训练<a title="Permanent link" class=headerlink href=#_2>¶</a></h2><p>copilot在数据预处理部分中给了这样的代码<div class="language-python highlight"><pre><span></span><code><span id=__span-3-1><a href=#__codelineno-3-1 id=__codelineno-3-1 name=__codelineno-3-1></a><span class=c1># 标准化数据</span>
</span><span id=__span-3-2><a href=#__codelineno-3-2 id=__codelineno-3-2 name=__codelineno-3-2></a><span class=n>scaler</span> <span class=o>=</span> <span class=n>StandardScaler</span><span class=p>()</span>
</span><span id=__span-3-3><a href=#__codelineno-3-3 id=__codelineno-3-3 name=__codelineno-3-3></a><span class=n>X</span> <span class=o>=</span> <span class=n>scaler</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span></code></pre></div><p>不太清楚<em>标准化数据</em>的含义，于是让copilot对此进行解释<details class=example open><summary>对话记录</summary> <p>RonaldLN:</p> <p><code>@workspace</code> <code>/explain</code> Write an explanation for the active selection as paragraphs of text.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-4-1><a href=#__codelineno-4-1 id=__codelineno-4-1 name=__codelineno-4-1></a><span class=c1># 标准化数据</span>
</span><span id=__span-4-2><a href=#__codelineno-4-2 id=__codelineno-4-2 name=__codelineno-4-2></a><span class=n>scaler</span> <span class=o>=</span> <span class=n>StandardScaler</span><span class=p>()</span>
</span><span id=__span-4-3><a href=#__codelineno-4-3 id=__codelineno-4-3 name=__codelineno-4-3></a><span class=n>X</span> <span class=o>=</span> <span class=n>scaler</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span></code></pre></div> <p> </p> <p>Github Copilot:</p> <details class=quote><summary>已使用 3 引用</summary> <ul><li>train_data.py: 48-50<li>.../sklearn/base.py: 1043<li>.../sklearn/preprocessing/_base.py: 694</ul></details> <p>这段代码的目的是对数据进行标准化处理。标准化是一种常见的数据预处理方法，它可以使得不同规模和量纲的数据转化为相同的规模，便于进行后续的数据分析或者模型训练。</p> <p>首先，<code>StandardScaler()</code>是来自<code>sklearn.preprocessing</code>模块的一个类，用于实现数据的标准化处理。这个类的实例化结果被赋值给了变量<code>scaler</code>。</p> <p>然后，<code>scaler.fit_transform(X)</code>这个函数调用做了两件事情。首先，<code>fit</code>方法会计算数据<code>X</code>的均值和标准差。然后，<code>transform</code>方法会使用这些计算出的均值和标准差来对数据<code>X</code>进行标准化处理。标准化处理的结果会替换原来的<code>X</code>。</p> <p>标准化处理后的数据<code>X</code>的每个特征（列）的均值为0，标准差为1。这样处理后的数据更适合作为机器学习算法的输入，因为许多机器学习算法都假设输入数据的特征是均值为0，标准差为1的。</p></details><hr><p>在评估模型部分中，copilot生成了这样的代码<div class="language-python highlight"><pre><span></span><code><span id=__span-5-1><a href=#__codelineno-5-1 id=__codelineno-5-1 name=__codelineno-5-1></a><span class=n>cr</span> <span class=o>=</span> <span class=n>classification_report</span><span class=p>(</span><span class=n>y_test</span><span class=p>,</span> <span class=n>y_pred</span><span class=p>)</span>
</span><span id=__span-5-2><a href=#__codelineno-5-2 id=__codelineno-5-2 name=__codelineno-5-2></a><span class=nb>print</span><span class=p>(</span><span class=s1>'Classification Report: '</span><span class=p>)</span>
</span><span id=__span-5-3><a href=#__codelineno-5-3 id=__codelineno-5-3 name=__codelineno-5-3></a><span class=nb>print</span><span class=p>(</span><span class=n>cr</span><span class=p>)</span>
</span></code></pre></div><p>输出的显示是这样的<div class="language-bash highlight"><pre><span></span><code><span id=__span-6-1><a href=#__codelineno-6-1 id=__codelineno-6-1 name=__codelineno-6-1></a>Classification<span class=w> </span>Report:<span class=w> </span>
</span><span id=__span-6-2><a href=#__codelineno-6-2 id=__codelineno-6-2 name=__codelineno-6-2></a><span class=w>              </span>precision<span class=w>    </span>recall<span class=w>  </span>f1-score<span class=w>   </span>support
</span><span id=__span-6-3><a href=#__codelineno-6-3 id=__codelineno-6-3 name=__codelineno-6-3></a>
</span><span id=__span-6-4><a href=#__codelineno-6-4 id=__codelineno-6-4 name=__codelineno-6-4></a><span class=w>         </span><span class=m>0</span>.0<span class=w>       </span><span class=m>0</span>.96<span class=w>      </span><span class=m>1</span>.00<span class=w>      </span><span class=m>0</span>.98<span class=w>        </span><span class=m>23</span>
</span><span id=__span-6-5><a href=#__codelineno-6-5 id=__codelineno-6-5 name=__codelineno-6-5></a><span class=w>         </span><span class=m>1</span>.0<span class=w>       </span><span class=m>0</span>.41<span class=w>      </span><span class=m>0</span>.44<span class=w>      </span><span class=m>0</span>.42<span class=w>        </span><span class=m>25</span>
</span><span id=__span-6-6><a href=#__codelineno-6-6 id=__codelineno-6-6 name=__codelineno-6-6></a><span class=w>         </span><span class=m>2</span>.0<span class=w>       </span><span class=m>0</span>.55<span class=w>      </span><span class=m>0</span>.50<span class=w>      </span><span class=m>0</span>.52<span class=w>        </span><span class=m>32</span>
</span><span id=__span-6-7><a href=#__codelineno-6-7 id=__codelineno-6-7 name=__codelineno-6-7></a>
</span><span id=__span-6-8><a href=#__codelineno-6-8 id=__codelineno-6-8 name=__codelineno-6-8></a><span class=w>    </span>accuracy<span class=w>                           </span><span class=m>0</span>.62<span class=w>        </span><span class=m>80</span>
</span><span id=__span-6-9><a href=#__codelineno-6-9 id=__codelineno-6-9 name=__codelineno-6-9></a><span class=w>   </span>macro<span class=w> </span>avg<span class=w>       </span><span class=m>0</span>.64<span class=w>      </span><span class=m>0</span>.65<span class=w>      </span><span class=m>0</span>.64<span class=w>        </span><span class=m>80</span>
</span><span id=__span-6-10><a href=#__codelineno-6-10 id=__codelineno-6-10 name=__codelineno-6-10></a>weighted<span class=w> </span>avg<span class=w>       </span><span class=m>0</span>.62<span class=w>      </span><span class=m>0</span>.62<span class=w>      </span><span class=m>0</span>.62<span class=w>        </span><span class=m>80</span>
</span></code></pre></div><p>不太清楚具体的含义，于是询问copilot<details class=example open><summary>对话记录</summary> <p>RonaldLN:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-7-1><a href=#__codelineno-7-1 id=__codelineno-7-1 name=__codelineno-7-1></a>Classification<span class=w> </span>Report:<span class=w> </span>
</span><span id=__span-7-2><a href=#__codelineno-7-2 id=__codelineno-7-2 name=__codelineno-7-2></a><span class=w>              </span>precision<span class=w>    </span>recall<span class=w>  </span>f1-score<span class=w>   </span>support
</span><span id=__span-7-3><a href=#__codelineno-7-3 id=__codelineno-7-3 name=__codelineno-7-3></a>
</span><span id=__span-7-4><a href=#__codelineno-7-4 id=__codelineno-7-4 name=__codelineno-7-4></a><span class=w>         </span><span class=m>0</span>.0<span class=w>       </span><span class=m>0</span>.96<span class=w>      </span><span class=m>1</span>.00<span class=w>      </span><span class=m>0</span>.98<span class=w>        </span><span class=m>23</span>
</span><span id=__span-7-5><a href=#__codelineno-7-5 id=__codelineno-7-5 name=__codelineno-7-5></a><span class=w>         </span><span class=m>1</span>.0<span class=w>       </span><span class=m>0</span>.41<span class=w>      </span><span class=m>0</span>.44<span class=w>      </span><span class=m>0</span>.42<span class=w>        </span><span class=m>25</span>
</span><span id=__span-7-6><a href=#__codelineno-7-6 id=__codelineno-7-6 name=__codelineno-7-6></a><span class=w>         </span><span class=m>2</span>.0<span class=w>       </span><span class=m>0</span>.55<span class=w>      </span><span class=m>0</span>.50<span class=w>      </span><span class=m>0</span>.52<span class=w>        </span><span class=m>32</span>
</span><span id=__span-7-7><a href=#__codelineno-7-7 id=__codelineno-7-7 name=__codelineno-7-7></a>
</span><span id=__span-7-8><a href=#__codelineno-7-8 id=__codelineno-7-8 name=__codelineno-7-8></a><span class=w>    </span>accuracy<span class=w>                           </span><span class=m>0</span>.62<span class=w>        </span><span class=m>80</span>
</span><span id=__span-7-9><a href=#__codelineno-7-9 id=__codelineno-7-9 name=__codelineno-7-9></a><span class=w>   </span>macro<span class=w> </span>avg<span class=w>       </span><span class=m>0</span>.64<span class=w>      </span><span class=m>0</span>.65<span class=w>      </span><span class=m>0</span>.64<span class=w>        </span><span class=m>80</span>
</span><span id=__span-7-10><a href=#__codelineno-7-10 id=__codelineno-7-10 name=__codelineno-7-10></a>weighted<span class=w> </span>avg<span class=w>       </span><span class=m>0</span>.62<span class=w>      </span><span class=m>0</span>.62<span class=w>      </span><span class=m>0</span>.62<span class=w>        </span><span class=m>80</span>
</span></code></pre></div> <p>解释一下这个</p> <p> </p> <p>Github Copilot:</p> <details class=quote><summary>已使用 1 引用</summary> <ul><li>train_data.py: 85-104</ul></details> <p>这是一个分类报告，它提供了模型在每个类别上的性能度量。</p> <ul><li><code>precision</code>：精确率，表示被模型预测为正类的样本中，实际上也是正类的比例。例如，对于类别0，精确率为0.96，表示模型预测为类别0的样本中，96%实际上是类别0。<li><code>recall</code>：召回率，表示实际上是正类的样本中，被模型正确预测的比例。例如，对于类别0，召回率为1.00，表示所有实际上是类别0的样本，都被模型正确预测了。<li><code>f1-score</code>：F1分数，是精确率和召回率的调和平均值，用于同时考虑精确率和召回率的性能度量。例如，对于类别0，F1分数为0.98，表示精确率和召回率的调和平均值为0.98。<li><code>support</code>：支持度，表示每个类别的样本数量。例如，类别0有23个样本，类别1有25个样本，类别2有32个样本。<li><code>accuracy</code>：准确率，表示所有样本中，被模型正确预测的比例。在这个例子中，准确率为0.62，表示62%的样本被正确预测。<li><code>macro avg</code>：宏平均，表示所有类别的平均精确率、召回率和F1分数，每个类别的权重相同。<li><code>weighted avg</code>：加权平均，表示所有类别的平均精确率、召回率和F1分数，每个类别的权重与其样本数量成比例。</ul> <p>从这个报告中，我们可以看出，模型在类别0上的性能最好，精确率、召回率和F1分数都很高。然而，对于类别1和2，模型的性能较差。</p></details><hr><p>进行训练之后发现，<code>epochs</code> 设置成200或300时预测的效果比较好<hr><blockquote><p>由于不清楚为什么输出层有3个神经元，于是询问了一下copilot</blockquote><details class=example open><summary>对话记录</summary> <p>RonaldLN:</p> <p><code>@workspace</code> <code>/explain</code> Write an explanation for the active selection as paragraphs of text.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-8-1><a href=#__codelineno-8-1 id=__codelineno-8-1 name=__codelineno-8-1></a><span class=c1># 构建MLP模型</span>
</span><span id=__span-8-2><a href=#__codelineno-8-2 id=__codelineno-8-2 name=__codelineno-8-2></a><span class=k>def</span><span class=w> </span><span class=nf>build_model</span><span class=p>(</span><span class=n>input_shape</span><span class=p>):</span>
</span><span id=__span-8-3><a href=#__codelineno-8-3 id=__codelineno-8-3 name=__codelineno-8-3></a>    <span class=n>model</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>models</span><span class=o>.</span><span class=n>Sequential</span><span class=p>([</span>
</span><span id=__span-8-4><a href=#__codelineno-8-4 id=__codelineno-8-4 name=__codelineno-8-4></a>        <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>layers</span><span class=o>.</span><span class=n>Dense</span><span class=p>(</span><span class=mi>128</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s1>'relu'</span><span class=p>,</span> <span class=n>input_shape</span><span class=o>=</span><span class=p>(</span><span class=n>input_shape</span><span class=p>,)),</span>
</span><span id=__span-8-5><a href=#__codelineno-8-5 id=__codelineno-8-5 name=__codelineno-8-5></a>        <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>layers</span><span class=o>.</span><span class=n>Dense</span><span class=p>(</span><span class=mi>64</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s1>'relu'</span><span class=p>),</span>
</span><span id=__span-8-6><a href=#__codelineno-8-6 id=__codelineno-8-6 name=__codelineno-8-6></a>        <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>layers</span><span class=o>.</span><span class=n>Dense</span><span class=p>(</span><span class=mi>32</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s1>'relu'</span><span class=p>),</span>
</span><span id=__span-8-7><a href=#__codelineno-8-7 id=__codelineno-8-7 name=__codelineno-8-7></a>        <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>layers</span><span class=o>.</span><span class=n>Dense</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s1>'softmax'</span><span class=p>)</span>
</span><span id=__span-8-8><a href=#__codelineno-8-8 id=__codelineno-8-8 name=__codelineno-8-8></a>    <span class=p>])</span>
</span></code></pre></div> <p> </p> <p>GitHub Copilot:</p> <p>这段代码定义了一个函数<code>build_model</code>，用于构建一个多层感知器（MLP）模型。MLP是一种前馈神经网络，它包含至少三层（一个输入层，一个或多个隐藏层，一个输出层）的节点。每一层都完全连接到下一层。</p> <p>在这个函数中，我们首先创建一个<code>Sequential</code>模型。<code>Sequential</code>模型是Keras中最简单的模型，它由多个网络层线性堆叠。</p> <p>然后，我们添加了四个<code>Dense</code>层。<code>Dense</code>层是最常用的层，它是全连接层，即这一层的每个神经元都与上一层的所有神经元相连。</p> <ul><li>第一层有128个神经元，激活函数为'relu'，输入形状为<code>input_shape</code>。'relu'是一种常用的激活函数，它可以增加模型的非线性。输入形状<code>input_shape</code>是一个元组，表示输入数据的维度。<li>第二层有64个神经元，激活函数为'relu'。<li>第三层有32个神经元，激活函数为'relu'。<li>最后一层是输出层，有3个神经元，激活函数为'softmax'。'softmax'函数可以将一个实数向量转换为概率分布，因此这个模型的输出可以被解释为每个类别的概率。</ul> <p>这个函数最后返回构建好的模型。</p> <p> </p> <p>RonaldLN:</p> <p>输出层为什么有3个神经元？</p> <p> </p> <p>GitHub Copilot:</p> <p>输出层的神经元数量通常与你要解决的问题的类别数量相对应。在这个例子中，输出层有3个神经元，这意味着你的模型是在解决一个三分类问题。</p> <p>在多分类问题中，我们通常使用softmax激活函数，它可以将模型的输出转换为概率分布，这样每个神经元的输出就可以被解释为对应类别的概率。在这个例子中，模型的输出是一个包含三个元素的向量，每个元素代表一个类别的概率。</p></details><h2 id=shap>尝试使用SHAP值对模型进行分析<a title="Permanent link" class=headerlink href=#shap>¶</a></h2><p>让chatgpt根据 <code>train_data.py</code> 写使用shap分析模型的python代码<details class=example open><summary>对话记录</summary> <p>You:</p> <p>我想使用SHAP值来分析 <code>train_data.py</code> 中训练出来的模型的关键的特征，你能帮我编写一个新的文件吗？</p> <div class="language-python highlight"><span class=filename>train_data.py</span><pre><span></span><code><span id=__span-9-1><a href=#__codelineno-9-1 id=__codelineno-9-1 name=__codelineno-9-1></a><span class=c1># 使用tensorflow搭建一个MLP模型，用于训练数据</span>
</span><span id=__span-9-2><a href=#__codelineno-9-2 id=__codelineno-9-2 name=__codelineno-9-2></a>
</span><span id=__span-9-3><a href=#__codelineno-9-3 id=__codelineno-9-3 name=__codelineno-9-3></a><span class=kn>import</span><span class=w> </span><span class=nn>tensorflow</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>tf</span>
</span><span id=__span-9-4><a href=#__codelineno-9-4 id=__codelineno-9-4 name=__codelineno-9-4></a><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
</span><span id=__span-9-5><a href=#__codelineno-9-5 id=__codelineno-9-5 name=__codelineno-9-5></a><span class=kn>from</span><span class=w> </span><span class=nn>sklearn.model_selection</span><span class=w> </span><span class=kn>import</span> <span class=n>train_test_split</span>
</span><span id=__span-9-6><a href=#__codelineno-9-6 id=__codelineno-9-6 name=__codelineno-9-6></a><span class=kn>from</span><span class=w> </span><span class=nn>sklearn.preprocessing</span><span class=w> </span><span class=kn>import</span> <span class=n>StandardScaler</span>
</span><span id=__span-9-7><a href=#__codelineno-9-7 id=__codelineno-9-7 name=__codelineno-9-7></a><span class=kn>from</span><span class=w> </span><span class=nn>sklearn.metrics</span><span class=w> </span><span class=kn>import</span> <span class=n>accuracy_score</span>
</span><span id=__span-9-8><a href=#__codelineno-9-8 id=__codelineno-9-8 name=__codelineno-9-8></a><span class=kn>from</span><span class=w> </span><span class=nn>sklearn.metrics</span><span class=w> </span><span class=kn>import</span> <span class=n>confusion_matrix</span>
</span><span id=__span-9-9><a href=#__codelineno-9-9 id=__codelineno-9-9 name=__codelineno-9-9></a><span class=kn>from</span><span class=w> </span><span class=nn>sklearn.metrics</span><span class=w> </span><span class=kn>import</span> <span class=n>classification_report</span>
</span><span id=__span-9-10><a href=#__codelineno-9-10 id=__codelineno-9-10 name=__codelineno-9-10></a><span class=kn>from</span><span class=w> </span><span class=nn>sklearn.metrics</span><span class=w> </span><span class=kn>import</span> <span class=n>roc_auc_score</span>
</span><span id=__span-9-11><a href=#__codelineno-9-11 id=__codelineno-9-11 name=__codelineno-9-11></a><span class=kn>from</span><span class=w> </span><span class=nn>sklearn.metrics</span><span class=w> </span><span class=kn>import</span> <span class=n>roc_curve</span>
</span><span id=__span-9-12><a href=#__codelineno-9-12 id=__codelineno-9-12 name=__codelineno-9-12></a><span class=kn>import</span><span class=w> </span><span class=nn>matplotlib.pyplot</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>plt</span>
</span><span id=__span-9-13><a href=#__codelineno-9-13 id=__codelineno-9-13 name=__codelineno-9-13></a><span class=kn>from</span><span class=w> </span><span class=nn>sklearn.utils</span><span class=w> </span><span class=kn>import</span> <span class=n>shuffle</span>
</span><span id=__span-9-14><a href=#__codelineno-9-14 id=__codelineno-9-14 name=__codelineno-9-14></a>
</span><span id=__span-9-15><a href=#__codelineno-9-15 id=__codelineno-9-15 name=__codelineno-9-15></a><span class=c1># 读取数据</span>
</span><span id=__span-9-16><a href=#__codelineno-9-16 id=__codelineno-9-16 name=__codelineno-9-16></a><span class=k>def</span><span class=w> </span><span class=nf>read_data</span><span class=p>():</span>
</span><span id=__span-9-17><a href=#__codelineno-9-17 id=__codelineno-9-17 name=__codelineno-9-17></a>    <span class=n>names</span> <span class=o>=</span> <span class=p>[</span><span class=s1>'附件1：Normal_exp'</span><span class=p>,</span> <span class=s1>'附件2：EarlyStage_exp'</span><span class=p>,</span> <span class=s1>'附件3：LaterStage_exp'</span><span class=p>]</span>
</span><span id=__span-9-18><a href=#__codelineno-9-18 id=__codelineno-9-18 name=__codelineno-9-18></a>    <span class=n>data</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-9-19><a href=#__codelineno-9-19 id=__codelineno-9-19 name=__codelineno-9-19></a>    <span class=k>for</span> <span class=n>n</span> <span class=ow>in</span> <span class=n>names</span><span class=p>:</span>
</span><span id=__span-9-20><a href=#__codelineno-9-20 id=__codelineno-9-20 name=__codelineno-9-20></a>        <span class=n>classfied</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>n</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span> <span class=o>-</span> <span class=mi>1</span>
</span><span id=__span-9-21><a href=#__codelineno-9-21 id=__codelineno-9-21 name=__codelineno-9-21></a>        <span class=n>d</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>n</span> <span class=o>+</span> <span class=s1>'_t.npy'</span><span class=p>,</span> <span class=n>allow_pickle</span><span class=o>=</span><span class=kc>True</span><span class=p>)[</span><span class=mi>1</span><span class=p>:,</span> <span class=p>:]</span>  <span class=c1># 去掉第一行(基因编号)</span>
</span><span id=__span-9-22><a href=#__codelineno-9-22 id=__codelineno-9-22 name=__codelineno-9-22></a>        <span class=c1># 添加标签</span>
</span><span id=__span-9-23><a href=#__codelineno-9-23 id=__codelineno-9-23 name=__codelineno-9-23></a>        <span class=n>d</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>insert</span><span class=p>(</span><span class=n>d</span><span class=p>,</span> <span class=n>d</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>classfied</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-9-24><a href=#__codelineno-9-24 id=__codelineno-9-24 name=__codelineno-9-24></a>        <span class=c1># print(d)</span>
</span><span id=__span-9-25><a href=#__codelineno-9-25 id=__codelineno-9-25 name=__codelineno-9-25></a>        <span class=n>data</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>d</span><span class=p>)</span>
</span><span id=__span-9-26><a href=#__codelineno-9-26 id=__codelineno-9-26 name=__codelineno-9-26></a>    <span class=k>return</span> <span class=n>data</span>
</span><span id=__span-9-27><a href=#__codelineno-9-27 id=__codelineno-9-27 name=__codelineno-9-27></a>
</span><span id=__span-9-28><a href=#__codelineno-9-28 id=__codelineno-9-28 name=__codelineno-9-28></a><span class=c1># 将3个array数组合并</span>
</span><span id=__span-9-29><a href=#__codelineno-9-29 id=__codelineno-9-29 name=__codelineno-9-29></a><span class=k>def</span><span class=w> </span><span class=nf>merge_data</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
</span><span id=__span-9-30><a href=#__codelineno-9-30 id=__codelineno-9-30 name=__codelineno-9-30></a>    <span class=n>data</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-9-31><a href=#__codelineno-9-31 id=__codelineno-9-31 name=__codelineno-9-31></a>    <span class=c1># print(data)</span>
</span><span id=__span-9-32><a href=#__codelineno-9-32 id=__codelineno-9-32 name=__codelineno-9-32></a>    <span class=c1># print(data.shape)</span>
</span><span id=__span-9-33><a href=#__codelineno-9-33 id=__codelineno-9-33 name=__codelineno-9-33></a>    <span class=n>np</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=s1>'merged_data.npy'</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span><span id=__span-9-34><a href=#__codelineno-9-34 id=__codelineno-9-34 name=__codelineno-9-34></a>    <span class=k>return</span> <span class=n>data</span>
</span><span id=__span-9-35><a href=#__codelineno-9-35 id=__codelineno-9-35 name=__codelineno-9-35></a>
</span><span id=__span-9-36><a href=#__codelineno-9-36 id=__codelineno-9-36 name=__codelineno-9-36></a><span class=c1># 数据预处理</span>
</span><span id=__span-9-37><a href=#__codelineno-9-37 id=__codelineno-9-37 name=__codelineno-9-37></a><span class=k>def</span><span class=w> </span><span class=nf>preprocess</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
</span><span id=__span-9-38><a href=#__codelineno-9-38 id=__codelineno-9-38 name=__codelineno-9-38></a>    <span class=c1># 随机打乱数据</span>
</span><span id=__span-9-39><a href=#__codelineno-9-39 id=__codelineno-9-39 name=__codelineno-9-39></a>    <span class=n>data</span> <span class=o>=</span> <span class=n>shuffle</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>
</span><span id=__span-9-40><a href=#__codelineno-9-40 id=__codelineno-9-40 name=__codelineno-9-40></a>    <span class=nb>print</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-9-41><a href=#__codelineno-9-41 id=__codelineno-9-41 name=__codelineno-9-41></a>
</span><span id=__span-9-42><a href=#__codelineno-9-42 id=__codelineno-9-42 name=__codelineno-9-42></a>    <span class=c1># 将数据分为特征和标签</span>
</span><span id=__span-9-43><a href=#__codelineno-9-43 id=__codelineno-9-43 name=__codelineno-9-43></a>    <span class=n>X</span> <span class=o>=</span> <span class=n>data</span><span class=p>[:,</span> <span class=p>:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-9-44><a href=#__codelineno-9-44 id=__codelineno-9-44 name=__codelineno-9-44></a>    <span class=n>y</span> <span class=o>=</span> <span class=n>data</span><span class=p>[:,</span> <span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-9-45><a href=#__codelineno-9-45 id=__codelineno-9-45 name=__codelineno-9-45></a>
</span><span id=__span-9-46><a href=#__codelineno-9-46 id=__codelineno-9-46 name=__codelineno-9-46></a>    <span class=nb>print</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span><span id=__span-9-47><a href=#__codelineno-9-47 id=__codelineno-9-47 name=__codelineno-9-47></a>
</span><span id=__span-9-48><a href=#__codelineno-9-48 id=__codelineno-9-48 name=__codelineno-9-48></a>    <span class=c1># 标准化数据</span>
</span><span id=__span-9-49><a href=#__codelineno-9-49 id=__codelineno-9-49 name=__codelineno-9-49></a>    <span class=n>scaler</span> <span class=o>=</span> <span class=n>StandardScaler</span><span class=p>()</span>
</span><span id=__span-9-50><a href=#__codelineno-9-50 id=__codelineno-9-50 name=__codelineno-9-50></a>    <span class=n>X</span> <span class=o>=</span> <span class=n>scaler</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span><span id=__span-9-51><a href=#__codelineno-9-51 id=__codelineno-9-51 name=__codelineno-9-51></a>    <span class=nb>print</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span><span id=__span-9-52><a href=#__codelineno-9-52 id=__codelineno-9-52 name=__codelineno-9-52></a>
</span><span id=__span-9-53><a href=#__codelineno-9-53 id=__codelineno-9-53 name=__codelineno-9-53></a>    <span class=c1># 划分训练集和测试集</span>
</span><span id=__span-9-54><a href=#__codelineno-9-54 id=__codelineno-9-54 name=__codelineno-9-54></a>    <span class=n>X_train</span><span class=p>,</span> <span class=n>X_test</span><span class=p>,</span> <span class=n>y_train</span><span class=p>,</span> <span class=n>y_test</span> <span class=o>=</span> <span class=n>train_test_split</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>test_size</span><span class=o>=</span><span class=mf>0.2</span><span class=p>,</span> <span class=n>random_state</span><span class=o>=</span><span class=mi>50</span><span class=p>)</span>
</span><span id=__span-9-55><a href=#__codelineno-9-55 id=__codelineno-9-55 name=__codelineno-9-55></a>
</span><span id=__span-9-56><a href=#__codelineno-9-56 id=__codelineno-9-56 name=__codelineno-9-56></a>    <span class=n>X_train</span> <span class=o>=</span> <span class=n>X_train</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=s1>'float32'</span><span class=p>)</span>
</span><span id=__span-9-57><a href=#__codelineno-9-57 id=__codelineno-9-57 name=__codelineno-9-57></a>    <span class=n>X_test</span> <span class=o>=</span> <span class=n>X_test</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=s1>'float32'</span><span class=p>)</span>
</span><span id=__span-9-58><a href=#__codelineno-9-58 id=__codelineno-9-58 name=__codelineno-9-58></a>    <span class=n>y_train</span> <span class=o>=</span> <span class=n>y_train</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=s1>'float32'</span><span class=p>)</span>
</span><span id=__span-9-59><a href=#__codelineno-9-59 id=__codelineno-9-59 name=__codelineno-9-59></a>    <span class=n>y_test</span> <span class=o>=</span> <span class=n>y_test</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=s1>'float32'</span><span class=p>)</span>
</span><span id=__span-9-60><a href=#__codelineno-9-60 id=__codelineno-9-60 name=__codelineno-9-60></a>
</span><span id=__span-9-61><a href=#__codelineno-9-61 id=__codelineno-9-61 name=__codelineno-9-61></a>    <span class=k>return</span> <span class=n>X_train</span><span class=p>,</span> <span class=n>X_test</span><span class=p>,</span> <span class=n>y_train</span><span class=p>,</span> <span class=n>y_test</span>
</span><span id=__span-9-62><a href=#__codelineno-9-62 id=__codelineno-9-62 name=__codelineno-9-62></a>
</span><span id=__span-9-63><a href=#__codelineno-9-63 id=__codelineno-9-63 name=__codelineno-9-63></a><span class=sd>"""</span>
</span><span id=__span-9-64><a href=#__codelineno-9-64 id=__codelineno-9-64 name=__codelineno-9-64></a><span class=sd>说明：</span>
</span><span id=__span-9-65><a href=#__codelineno-9-65 id=__codelineno-9-65 name=__codelineno-9-65></a><span class=sd>标签为0，1，2，分别代表Normal_exp，EarlyStage_exp，LaterStage_exp</span>
</span><span id=__span-9-66><a href=#__codelineno-9-66 id=__codelineno-9-66 name=__codelineno-9-66></a><span class=sd>"""</span>
</span><span id=__span-9-67><a href=#__codelineno-9-67 id=__codelineno-9-67 name=__codelineno-9-67></a>
</span><span id=__span-9-68><a href=#__codelineno-9-68 id=__codelineno-9-68 name=__codelineno-9-68></a><span class=c1># 构建MLP模型</span>
</span><span id=__span-9-69><a href=#__codelineno-9-69 id=__codelineno-9-69 name=__codelineno-9-69></a><span class=k>def</span><span class=w> </span><span class=nf>build_model</span><span class=p>(</span><span class=n>input_shape</span><span class=p>):</span>
</span><span id=__span-9-70><a href=#__codelineno-9-70 id=__codelineno-9-70 name=__codelineno-9-70></a>    <span class=n>model</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>models</span><span class=o>.</span><span class=n>Sequential</span><span class=p>([</span>
</span><span id=__span-9-71><a href=#__codelineno-9-71 id=__codelineno-9-71 name=__codelineno-9-71></a>        <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>layers</span><span class=o>.</span><span class=n>Dense</span><span class=p>(</span><span class=mi>128</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s1>'relu'</span><span class=p>,</span> <span class=n>input_shape</span><span class=o>=</span><span class=p>(</span><span class=n>input_shape</span><span class=p>,)),</span>
</span><span id=__span-9-72><a href=#__codelineno-9-72 id=__codelineno-9-72 name=__codelineno-9-72></a>        <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>layers</span><span class=o>.</span><span class=n>Dense</span><span class=p>(</span><span class=mi>64</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s1>'relu'</span><span class=p>),</span>
</span><span id=__span-9-73><a href=#__codelineno-9-73 id=__codelineno-9-73 name=__codelineno-9-73></a>        <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>layers</span><span class=o>.</span><span class=n>Dense</span><span class=p>(</span><span class=mi>32</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s1>'relu'</span><span class=p>),</span>
</span><span id=__span-9-74><a href=#__codelineno-9-74 id=__codelineno-9-74 name=__codelineno-9-74></a>        <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>layers</span><span class=o>.</span><span class=n>Dense</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s1>'softmax'</span><span class=p>)</span>
</span><span id=__span-9-75><a href=#__codelineno-9-75 id=__codelineno-9-75 name=__codelineno-9-75></a>    <span class=p>])</span>
</span><span id=__span-9-76><a href=#__codelineno-9-76 id=__codelineno-9-76 name=__codelineno-9-76></a>
</span><span id=__span-9-77><a href=#__codelineno-9-77 id=__codelineno-9-77 name=__codelineno-9-77></a>    <span class=n>model</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span><span class=n>optimizer</span><span class=o>=</span><span class=s1>'adam'</span><span class=p>,</span> <span class=n>loss</span><span class=o>=</span><span class=s1>'sparse_categorical_crossentropy'</span><span class=p>,</span> <span class=n>metrics</span><span class=o>=</span><span class=p>[</span><span class=s1>'accuracy'</span><span class=p>])</span>
</span><span id=__span-9-78><a href=#__codelineno-9-78 id=__codelineno-9-78 name=__codelineno-9-78></a>
</span><span id=__span-9-79><a href=#__codelineno-9-79 id=__codelineno-9-79 name=__codelineno-9-79></a>    <span class=k>return</span> <span class=n>model</span>
</span><span id=__span-9-80><a href=#__codelineno-9-80 id=__codelineno-9-80 name=__codelineno-9-80></a>
</span><span id=__span-9-81><a href=#__codelineno-9-81 id=__codelineno-9-81 name=__codelineno-9-81></a><span class=c1># 训练模型</span>
</span><span id=__span-9-82><a href=#__codelineno-9-82 id=__codelineno-9-82 name=__codelineno-9-82></a><span class=k>def</span><span class=w> </span><span class=nf>train_model</span><span class=p>(</span><span class=n>X_train</span><span class=p>,</span> <span class=n>y_train</span><span class=p>,</span> <span class=n>epochs</span><span class=p>):</span>
</span><span id=__span-9-83><a href=#__codelineno-9-83 id=__codelineno-9-83 name=__codelineno-9-83></a>    <span class=n>model</span> <span class=o>=</span> <span class=n>build_model</span><span class=p>(</span><span class=n>X_train</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span><span id=__span-9-84><a href=#__codelineno-9-84 id=__codelineno-9-84 name=__codelineno-9-84></a>    <span class=n>model</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>X_train</span><span class=p>,</span> <span class=n>y_train</span><span class=p>,</span> <span class=n>epochs</span><span class=o>=</span><span class=n>epochs</span><span class=p>,</span> <span class=n>batch_size</span><span class=o>=</span><span class=mi>32</span><span class=p>)</span>
</span><span id=__span-9-85><a href=#__codelineno-9-85 id=__codelineno-9-85 name=__codelineno-9-85></a>    <span class=k>return</span> <span class=n>model</span>
</span><span id=__span-9-86><a href=#__codelineno-9-86 id=__codelineno-9-86 name=__codelineno-9-86></a>
</span><span id=__span-9-87><a href=#__codelineno-9-87 id=__codelineno-9-87 name=__codelineno-9-87></a><span class=c1># 评估模型</span>
</span><span id=__span-9-88><a href=#__codelineno-9-88 id=__codelineno-9-88 name=__codelineno-9-88></a><span class=k>def</span><span class=w> </span><span class=nf>evaluate_model</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>X_test</span><span class=p>,</span> <span class=n>y_test</span><span class=p>):</span>
</span><span id=__span-9-89><a href=#__codelineno-9-89 id=__codelineno-9-89 name=__codelineno-9-89></a>    <span class=n>y_pred</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>X_test</span><span class=p>)</span>
</span><span id=__span-9-90><a href=#__codelineno-9-90 id=__codelineno-9-90 name=__codelineno-9-90></a>    <span class=n>y_pred</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>argmax</span><span class=p>(</span><span class=n>y_pred</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-9-91><a href=#__codelineno-9-91 id=__codelineno-9-91 name=__codelineno-9-91></a>    <span class=nb>print</span><span class=p>(</span><span class=n>y_pred</span><span class=p>)</span>
</span><span id=__span-9-92><a href=#__codelineno-9-92 id=__codelineno-9-92 name=__codelineno-9-92></a>
</span><span id=__span-9-93><a href=#__codelineno-9-93 id=__codelineno-9-93 name=__codelineno-9-93></a>    <span class=n>acc</span> <span class=o>=</span> <span class=n>accuracy_score</span><span class=p>(</span><span class=n>y_test</span><span class=p>,</span> <span class=n>y_pred</span><span class=p>)</span>
</span><span id=__span-9-94><a href=#__codelineno-9-94 id=__codelineno-9-94 name=__codelineno-9-94></a>    <span class=nb>print</span><span class=p>(</span><span class=s1>'Accuracy: '</span><span class=p>,</span> <span class=n>acc</span><span class=p>)</span>
</span><span id=__span-9-95><a href=#__codelineno-9-95 id=__codelineno-9-95 name=__codelineno-9-95></a>
</span><span id=__span-9-96><a href=#__codelineno-9-96 id=__codelineno-9-96 name=__codelineno-9-96></a>    <span class=n>cm</span> <span class=o>=</span> <span class=n>confusion_matrix</span><span class=p>(</span><span class=n>y_test</span><span class=p>,</span> <span class=n>y_pred</span><span class=p>)</span>
</span><span id=__span-9-97><a href=#__codelineno-9-97 id=__codelineno-9-97 name=__codelineno-9-97></a>    <span class=nb>print</span><span class=p>(</span><span class=s1>'Confusion Matrix: '</span><span class=p>)</span>
</span><span id=__span-9-98><a href=#__codelineno-9-98 id=__codelineno-9-98 name=__codelineno-9-98></a>    <span class=nb>print</span><span class=p>(</span><span class=n>cm</span><span class=p>)</span>
</span><span id=__span-9-99><a href=#__codelineno-9-99 id=__codelineno-9-99 name=__codelineno-9-99></a>
</span><span id=__span-9-100><a href=#__codelineno-9-100 id=__codelineno-9-100 name=__codelineno-9-100></a>    <span class=n>cr</span> <span class=o>=</span> <span class=n>classification_report</span><span class=p>(</span><span class=n>y_test</span><span class=p>,</span> <span class=n>y_pred</span><span class=p>)</span>
</span><span id=__span-9-101><a href=#__codelineno-9-101 id=__codelineno-9-101 name=__codelineno-9-101></a>    <span class=nb>print</span><span class=p>(</span><span class=s1>'Classification Report: '</span><span class=p>)</span>
</span><span id=__span-9-102><a href=#__codelineno-9-102 id=__codelineno-9-102 name=__codelineno-9-102></a>    <span class=nb>print</span><span class=p>(</span><span class=n>cr</span><span class=p>)</span>
</span><span id=__span-9-103><a href=#__codelineno-9-103 id=__codelineno-9-103 name=__codelineno-9-103></a>
</span><span id=__span-9-104><a href=#__codelineno-9-104 id=__codelineno-9-104 name=__codelineno-9-104></a>    <span class=c1># y_pred = model.predict(X_test)</span>
</span><span id=__span-9-105><a href=#__codelineno-9-105 id=__codelineno-9-105 name=__codelineno-9-105></a>    <span class=c1># y_pred = np.argmax(y_pred, axis=1)</span>
</span><span id=__span-9-106><a href=#__codelineno-9-106 id=__codelineno-9-106 name=__codelineno-9-106></a>    <span class=c1># y_test = y_test.astype('int32')</span>
</span><span id=__span-9-107><a href=#__codelineno-9-107 id=__codelineno-9-107 name=__codelineno-9-107></a>    <span class=c1># print(y_test)</span>
</span><span id=__span-9-108><a href=#__codelineno-9-108 id=__codelineno-9-108 name=__codelineno-9-108></a>    <span class=c1># print(y_pred)</span>
</span><span id=__span-9-109><a href=#__codelineno-9-109 id=__codelineno-9-109 name=__codelineno-9-109></a>    <span class=c1># # roc_auc = roc_auc_score(y_test, y_pred, multi_class='ovr', average='weighted')</span>
</span><span id=__span-9-110><a href=#__codelineno-9-110 id=__codelineno-9-110 name=__codelineno-9-110></a>    <span class=c1># # print('ROC AUC: ', roc_auc)</span>
</span><span id=__span-9-111><a href=#__codelineno-9-111 id=__codelineno-9-111 name=__codelineno-9-111></a>
</span><span id=__span-9-112><a href=#__codelineno-9-112 id=__codelineno-9-112 name=__codelineno-9-112></a>    <span class=c1># # fpr = dict()</span>
</span><span id=__span-9-113><a href=#__codelineno-9-113 id=__codelineno-9-113 name=__codelineno-9-113></a>    <span class=c1># # tpr = dict()</span>
</span><span id=__span-9-114><a href=#__codelineno-9-114 id=__codelineno-9-114 name=__codelineno-9-114></a>    <span class=c1># # roc_auc = dict()</span>
</span><span id=__span-9-115><a href=#__codelineno-9-115 id=__codelineno-9-115 name=__codelineno-9-115></a>    <span class=c1># # for i in range(3):</span>
</span><span id=__span-9-116><a href=#__codelineno-9-116 id=__codelineno-9-116 name=__codelineno-9-116></a>    <span class=c1># #     fpr[i], tpr[i], _ = roc_curve(y_test, y_pred, pos_label=i)</span>
</span><span id=__span-9-117><a href=#__codelineno-9-117 id=__codelineno-9-117 name=__codelineno-9-117></a>    <span class=c1># #     roc_auc[i] = roc_auc_score(y_test, y_pred, multi_class='ovr', average='weighted')</span>
</span><span id=__span-9-118><a href=#__codelineno-9-118 id=__codelineno-9-118 name=__codelineno-9-118></a>    <span class=c1># # print(fpr)</span>
</span><span id=__span-9-119><a href=#__codelineno-9-119 id=__codelineno-9-119 name=__codelineno-9-119></a>    <span class=c1># # print(tpr)</span>
</span><span id=__span-9-120><a href=#__codelineno-9-120 id=__codelineno-9-120 name=__codelineno-9-120></a>    <span class=c1># # print(roc_auc)</span>
</span><span id=__span-9-121><a href=#__codelineno-9-121 id=__codelineno-9-121 name=__codelineno-9-121></a>
</span><span id=__span-9-122><a href=#__codelineno-9-122 id=__codelineno-9-122 name=__codelineno-9-122></a>    <span class=c1># plt.figure()</span>
</span><span id=__span-9-123><a href=#__codelineno-9-123 id=__codelineno-9-123 name=__codelineno-9-123></a>    <span class=c1># lw = 2</span>
</span><span id=__span-9-124><a href=#__codelineno-9-124 id=__codelineno-9-124 name=__codelineno-9-124></a>    <span class=c1># # colors = ['aqua', 'darkorange', 'cornflowerblue']</span>
</span><span id=__span-9-125><a href=#__codelineno-9-125 id=__codelineno-9-125 name=__codelineno-9-125></a>    <span class=c1># # for i, color in zip(range(3), colors):</span>
</span><span id=__span-9-126><a href=#__codelineno-9-126 id=__codelineno-9-126 name=__codelineno-9-126></a>    <span class=c1># #     plt.plot(fpr[i], tpr[i], color=color, lw=lw, label='ROC curve of class {0} (area = {1:0.2f})'.format(i, roc_auc[i]))</span>
</span><span id=__span-9-127><a href=#__codelineno-9-127 id=__codelineno-9-127 name=__codelineno-9-127></a>    <span class=c1># plt.plot([0, 1], [0, 1], color='navy', lw=lw, linestyle='--')</span>
</span><span id=__span-9-128><a href=#__codelineno-9-128 id=__codelineno-9-128 name=__codelineno-9-128></a>    <span class=c1># plt.xlim([0.0, 1.0])</span>
</span><span id=__span-9-129><a href=#__codelineno-9-129 id=__codelineno-9-129 name=__codelineno-9-129></a>    <span class=c1># plt.ylim([0.0, 1.05])</span>
</span><span id=__span-9-130><a href=#__codelineno-9-130 id=__codelineno-9-130 name=__codelineno-9-130></a>    <span class=c1># plt.xlabel('False Positive Rate')</span>
</span><span id=__span-9-131><a href=#__codelineno-9-131 id=__codelineno-9-131 name=__codelineno-9-131></a>    <span class=c1># plt.ylabel('True Positive Rate')</span>
</span><span id=__span-9-132><a href=#__codelineno-9-132 id=__codelineno-9-132 name=__codelineno-9-132></a>    <span class=c1># plt.title('Receiver Operating Characteristic')</span>
</span><span id=__span-9-133><a href=#__codelineno-9-133 id=__codelineno-9-133 name=__codelineno-9-133></a>    <span class=c1># plt.legend(loc='lower right')</span>
</span><span id=__span-9-134><a href=#__codelineno-9-134 id=__codelineno-9-134 name=__codelineno-9-134></a>    <span class=c1># plt.show()</span>
</span><span id=__span-9-135><a href=#__codelineno-9-135 id=__codelineno-9-135 name=__codelineno-9-135></a>
</span><span id=__span-9-136><a href=#__codelineno-9-136 id=__codelineno-9-136 name=__codelineno-9-136></a>    <span class=k>return</span> <span class=n>acc</span>
</span><span id=__span-9-137><a href=#__codelineno-9-137 id=__codelineno-9-137 name=__codelineno-9-137></a>
</span><span id=__span-9-138><a href=#__codelineno-9-138 id=__codelineno-9-138 name=__codelineno-9-138></a><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>'__main__'</span><span class=p>:</span>
</span><span id=__span-9-139><a href=#__codelineno-9-139 id=__codelineno-9-139 name=__codelineno-9-139></a>    <span class=c1># data = read_data()</span>
</span><span id=__span-9-140><a href=#__codelineno-9-140 id=__codelineno-9-140 name=__codelineno-9-140></a>    <span class=c1># data = merge_data(data)</span>
</span><span id=__span-9-141><a href=#__codelineno-9-141 id=__codelineno-9-141 name=__codelineno-9-141></a>    <span class=n>data</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s1>'merged_data.npy'</span><span class=p>,</span> <span class=n>allow_pickle</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-9-142><a href=#__codelineno-9-142 id=__codelineno-9-142 name=__codelineno-9-142></a>    <span class=n>X_train</span><span class=p>,</span> <span class=n>X_test</span><span class=p>,</span> <span class=n>y_train</span><span class=p>,</span> <span class=n>y_test</span> <span class=o>=</span> <span class=n>preprocess</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-9-143><a href=#__codelineno-9-143 id=__codelineno-9-143 name=__codelineno-9-143></a>    <span class=n>epochs</span> <span class=o>=</span> <span class=mi>400</span>
</span><span id=__span-9-144><a href=#__codelineno-9-144 id=__codelineno-9-144 name=__codelineno-9-144></a>    <span class=n>model</span> <span class=o>=</span> <span class=n>train_model</span><span class=p>(</span><span class=n>X_train</span><span class=p>,</span> <span class=n>y_train</span><span class=p>,</span> <span class=n>epochs</span><span class=p>)</span>
</span><span id=__span-9-145><a href=#__codelineno-9-145 id=__codelineno-9-145 name=__codelineno-9-145></a>    <span class=n>acc</span> <span class=o>=</span> <span class=n>evaluate_model</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>X_test</span><span class=p>,</span> <span class=n>y_test</span><span class=p>)</span>
</span><span id=__span-9-146><a href=#__codelineno-9-146 id=__codelineno-9-146 name=__codelineno-9-146></a>    <span class=nb>print</span><span class=p>(</span><span class=s1>'Accuracy: '</span><span class=p>,</span> <span class=n>acc</span><span class=p>)</span>
</span><span id=__span-9-147><a href=#__codelineno-9-147 id=__codelineno-9-147 name=__codelineno-9-147></a>    <span class=n>model</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=sa>f</span><span class=s1>'model_</span><span class=si>{</span><span class=n>epochs</span><span class=si>}</span><span class=s1>.h5'</span><span class=p>)</span>
</span></code></pre></div> <p> </p> <p>ChatGPT:</p> <p>好的，你想要一个新的文件来使用 SHAP（SHapley Additive exPlanations）来解释模型的关键特征。SHAP 值可以帮助你理解模型对于每个特征的预测贡献。下面是一个示例文件 <code>shap_analysis.py</code>，用于解释 <code>train_data.py</code> 中训练出来的模型：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-10-1><a href=#__codelineno-10-1 id=__codelineno-10-1 name=__codelineno-10-1></a><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
</span><span id=__span-10-2><a href=#__codelineno-10-2 id=__codelineno-10-2 name=__codelineno-10-2></a><span class=kn>import</span><span class=w> </span><span class=nn>shap</span>
</span><span id=__span-10-3><a href=#__codelineno-10-3 id=__codelineno-10-3 name=__codelineno-10-3></a><span class=kn>from</span><span class=w> </span><span class=nn>train_data</span><span class=w> </span><span class=kn>import</span> <span class=n>preprocess</span><span class=p>,</span> <span class=n>build_model</span>
</span><span id=__span-10-4><a href=#__codelineno-10-4 id=__codelineno-10-4 name=__codelineno-10-4></a>
</span><span id=__span-10-5><a href=#__codelineno-10-5 id=__codelineno-10-5 name=__codelineno-10-5></a><span class=c1># 读取并预处理数据</span>
</span><span id=__span-10-6><a href=#__codelineno-10-6 id=__codelineno-10-6 name=__codelineno-10-6></a><span class=n>data</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s1>'merged_data.npy'</span><span class=p>,</span> <span class=n>allow_pickle</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-10-7><a href=#__codelineno-10-7 id=__codelineno-10-7 name=__codelineno-10-7></a><span class=n>X_train</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>preprocess</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-10-8><a href=#__codelineno-10-8 id=__codelineno-10-8 name=__codelineno-10-8></a>
</span><span id=__span-10-9><a href=#__codelineno-10-9 id=__codelineno-10-9 name=__codelineno-10-9></a><span class=c1># 构建模型</span>
</span><span id=__span-10-10><a href=#__codelineno-10-10 id=__codelineno-10-10 name=__codelineno-10-10></a><span class=n>model</span> <span class=o>=</span> <span class=n>build_model</span><span class=p>(</span><span class=n>X_train</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span><span id=__span-10-11><a href=#__codelineno-10-11 id=__codelineno-10-11 name=__codelineno-10-11></a><span class=n>model</span><span class=o>.</span><span class=n>load_weights</span><span class=p>(</span><span class=s1>'model_400.h5'</span><span class=p>)</span>  <span class=c1># 加载训练好的模型权重</span>
</span><span id=__span-10-12><a href=#__codelineno-10-12 id=__codelineno-10-12 name=__codelineno-10-12></a>
</span><span id=__span-10-13><a href=#__codelineno-10-13 id=__codelineno-10-13 name=__codelineno-10-13></a><span class=c1># 初始化一个 SHAP 解释器</span>
</span><span id=__span-10-14><a href=#__codelineno-10-14 id=__codelineno-10-14 name=__codelineno-10-14></a><span class=n>explainer</span> <span class=o>=</span> <span class=n>shap</span><span class=o>.</span><span class=n>Explainer</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>X_train</span><span class=p>)</span>
</span><span id=__span-10-15><a href=#__codelineno-10-15 id=__codelineno-10-15 name=__codelineno-10-15></a>
</span><span id=__span-10-16><a href=#__codelineno-10-16 id=__codelineno-10-16 name=__codelineno-10-16></a><span class=c1># 计算 SHAP 值</span>
</span><span id=__span-10-17><a href=#__codelineno-10-17 id=__codelineno-10-17 name=__codelineno-10-17></a><span class=n>shap_values</span> <span class=o>=</span> <span class=n>explainer</span><span class=p>(</span><span class=n>X_train</span><span class=p>)</span>
</span><span id=__span-10-18><a href=#__codelineno-10-18 id=__codelineno-10-18 name=__codelineno-10-18></a>
</span><span id=__span-10-19><a href=#__codelineno-10-19 id=__codelineno-10-19 name=__codelineno-10-19></a><span class=c1># 可视化 SHAP 值</span>
</span><span id=__span-10-20><a href=#__codelineno-10-20 id=__codelineno-10-20 name=__codelineno-10-20></a><span class=n>shap</span><span class=o>.</span><span class=n>summary_plot</span><span class=p>(</span><span class=n>shap_values</span><span class=p>,</span> <span class=n>X_train</span><span class=p>,</span> <span class=n>feature_names</span><span class=o>=</span><span class=p>[</span><span class=sa>f</span><span class=s1>'Feature </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1>'</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>X_train</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>])])</span>
</span></code></pre></div> <p>这个文件首先加载了训练好的模型和数据，然后使用 SHAP 解释器来计算并可视化 SHAP 值。你可以运行这个文件来查看每个特征对于模型预测的影响程度。确保安装了 <code>shap</code> 库，你可以使用 <code>pip install shap</code> 来安装。</p> <p> </p> <p>You:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-11-1><a href=#__codelineno-11-1 id=__codelineno-11-1 name=__codelineno-11-1></a>Traceback<span class=w> </span><span class=o>(</span>most<span class=w> </span>recent<span class=w> </span>call<span class=w> </span>last<span class=o>)</span>:
</span><span id=__span-11-2><a href=#__codelineno-11-2 id=__codelineno-11-2 name=__codelineno-11-2></a><span class=w>  </span>File<span class=w> </span><span class=s2>"c:\PycharmProjects\NPUCM24\testshap.py"</span>,<span class=w> </span>line<span class=w> </span><span class=m>17</span>,<span class=w> </span><span class=k>in</span><span class=w> </span>&lt;module>
</span><span id=__span-11-3><a href=#__codelineno-11-3 id=__codelineno-11-3 name=__codelineno-11-3></a><span class=w>    </span><span class=nv>shap_values</span><span class=w> </span><span class=o>=</span><span class=w> </span>explainer<span class=o>(</span>X_train<span class=o>)</span>
</span><span id=__span-11-4><a href=#__codelineno-11-4 id=__codelineno-11-4 name=__codelineno-11-4></a><span class=w>  </span>File<span class=w> </span><span class=s2>"C:\Users\Ronald\AppData\Local\Programs\Python\Python310\lib\site-packages\shap\explainers\_permutation.py"</span>,<span class=w> </span>line<span class=w> </span><span class=m>77</span>,<span class=w> </span><span class=k>in</span><span class=w> </span>__call__
</span><span id=__span-11-5><a href=#__codelineno-11-5 id=__codelineno-11-5 name=__codelineno-11-5></a><span class=w>    </span><span class=k>return</span><span class=w> </span>super<span class=o>()</span>.__call__<span class=o>(</span>
</span><span id=__span-11-6><a href=#__codelineno-11-6 id=__codelineno-11-6 name=__codelineno-11-6></a><span class=w>  </span>File<span class=w> </span><span class=s2>"C:\Users\Ronald\AppData\Local\Programs\Python\Python310\lib\site-packages\shap\explainers\_explainer.py"</span>,<span class=w> </span>line<span class=w> </span><span class=m>266</span>,<span class=w> </span><span class=k>in</span><span class=w> </span>__call__
</span><span id=__span-11-7><a href=#__codelineno-11-7 id=__codelineno-11-7 name=__codelineno-11-7></a><span class=w>    </span><span class=nv>row_result</span><span class=w> </span><span class=o>=</span><span class=w> </span>self.explain_row<span class=o>(</span>
</span><span id=__span-11-8><a href=#__codelineno-11-8 id=__codelineno-11-8 name=__codelineno-11-8></a><span class=w>  </span>File<span class=w> </span><span class=s2>"C:\Users\Ronald\AppData\Local\Programs\Python\Python310\lib\site-packages\shap\explainers\_permutation.py"</span>,<span class=w> </span>line<span class=w> </span><span class=m>157</span>,<span class=w> </span><span class=k>in</span><span class=w> </span>explain_row
</span><span id=__span-11-9><a href=#__codelineno-11-9 id=__codelineno-11-9 name=__codelineno-11-9></a><span class=w>    </span>raise<span class=w> </span>ValueError<span class=o>(</span>f<span class=s2>"max_evals={max_evals} is too low for the Permutation explainer, it must be at least 2 * num_features + 1 = {2 * len(inds) + 1}!"</span><span class=o>)</span>
</span><span id=__span-11-10><a href=#__codelineno-11-10 id=__codelineno-11-10 name=__codelineno-11-10></a>ValueError:<span class=w> </span><span class=nv>max_evals</span><span class=o>=</span><span class=m>500</span><span class=w> </span>is<span class=w> </span>too<span class=w> </span>low<span class=w> </span><span class=k>for</span><span class=w> </span>the<span class=w> </span>Permutation<span class=w> </span>explainer,<span class=w> </span>it<span class=w> </span>must<span class=w> </span>be<span class=w> </span>at<span class=w> </span>least<span class=w> </span><span class=m>2</span><span class=w> </span>*<span class=w> </span>num_features<span class=w> </span>+<span class=w> </span><span class=nv>1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>26327</span>!
</span></code></pre></div> <p>显示了上面这样的报错，应该如何修改？</p> <p> </p> <p>ChatGPT:</p> <p>这个报错提示 <code>max_evals</code> 参数设置过低，<code>max_evals</code> 是 Permutation Explainer 中的一个参数，用于控制计算 SHAP 值时的采样次数。根据报错信息，你的数据集具有 13163 个特征，所以至少需要 <code>2 * num_features + 1 = 26327</code> 次采样。</p> <p>你可以在初始化解释器时传入一个更大的 <code>max_evals</code> 参数来解决这个问题。例如：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-12-1><a href=#__codelineno-12-1 id=__codelineno-12-1 name=__codelineno-12-1></a><span class=c1># 初始化一个 SHAP 解释器，并指定更大的 max_evals 参数</span>
</span><span id=__span-12-2><a href=#__codelineno-12-2 id=__codelineno-12-2 name=__codelineno-12-2></a><span class=n>explainer</span> <span class=o>=</span> <span class=n>shap</span><span class=o>.</span><span class=n>Explainer</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>X_train</span><span class=p>,</span> <span class=n>algorithm</span><span class=o>=</span><span class=s2>"permutation"</span><span class=p>,</span> <span class=n>max_evals</span><span class=o>=</span><span class=mi>50000</span><span class=p>)</span>
</span></code></pre></div> <p>通过增加 <code>max_evals</code> 参数的值，你可以确保 SHAP 解释器能够充分地对模型进行解释。</p></details><p>然后再次进行运行时，显示了<div class="language-bash highlight"><pre><span></span><code><span id=__span-13-1><a href=#__codelineno-13-1 id=__codelineno-13-1 name=__codelineno-13-1></a>numpy.core._exceptions._ArrayMemoryError:<span class=w> </span>Unable<span class=w> </span>to<span class=w> </span>allocate<span class=w> </span><span class=m>258</span>.<span class=w> </span>GiB<span class=w> </span><span class=k>for</span><span class=w> </span>an<span class=w> </span>array<span class=w> </span>with<span class=w> </span>shape<span class=w> </span><span class=o>(</span><span class=m>2632700</span>,<span class=w> </span><span class=m>13163</span><span class=o>)</span><span class=w> </span>and<span class=w> </span>data<span class=w> </span><span class=nb>type</span><span class=w> </span>float64
</span></code></pre></div><p>猜测是内存不够的原因，<p>于是添加了一行<div class="language-python highlight"><pre><span></span><code><span id=__span-14-1><a href=#__codelineno-14-1 id=__codelineno-14-1 name=__codelineno-14-1></a><span class=n>X_train</span> <span class=o>=</span> <span class=n>X_train</span><span class=p>[:</span><span class=mi>3</span><span class=p>]</span>
</span></code></pre></div><p>然后就可以运行了，但是显示了另外一个报错<div class="language-bash highlight"><pre><span></span><code><span id=__span-15-1><a href=#__codelineno-15-1 id=__codelineno-15-1 name=__codelineno-15-1></a>Traceback<span class=w> </span><span class=o>(</span>most<span class=w> </span>recent<span class=w> </span>call<span class=w> </span>last<span class=o>)</span>:
</span><span id=__span-15-2><a href=#__codelineno-15-2 id=__codelineno-15-2 name=__codelineno-15-2></a><span class=w>  </span>File<span class=w> </span><span class=s2>"c:\PycharmProjects\NPUCM24\testshap.py"</span>,<span class=w> </span>line<span class=w> </span><span class=m>23</span>,<span class=w> </span><span class=k>in</span><span class=w> </span>&lt;module>
</span><span id=__span-15-3><a href=#__codelineno-15-3 id=__codelineno-15-3 name=__codelineno-15-3></a><span class=w>    </span>shap.summary_plot<span class=o>(</span>shap_values,<span class=w> </span>X_train,<span class=w> </span><span class=nv>feature_names</span><span class=o>=[</span>f<span class=s1>'Feature {i}'</span><span class=w> </span><span class=k>for</span><span class=w> </span>i<span class=w> </span><span class=k>in</span><span class=w> </span>range<span class=o>(</span>X_train.shape<span class=o>[</span><span class=m>1</span><span class=o>])])</span>
</span><span id=__span-15-4><a href=#__codelineno-15-4 id=__codelineno-15-4 name=__codelineno-15-4></a><span class=w>  </span>File<span class=w> </span><span class=s2>"C:\Users\Ronald\AppData\Local\Programs\Python\Python310\lib\site-packages\shap\plots\_beeswarm.py"</span>,<span class=w> </span>line<span class=w> </span><span class=m>607</span>,<span class=w> </span><span class=k>in</span><span class=w> </span>summary_legacy
</span><span id=__span-15-5><a href=#__codelineno-15-5 id=__codelineno-15-5 name=__codelineno-15-5></a><span class=w>    </span><span class=nv>feature_names</span><span class=o>=</span>feature_names<span class=o>[</span>sort_inds<span class=o>]</span>,
</span><span id=__span-15-6><a href=#__codelineno-15-6 id=__codelineno-15-6 name=__codelineno-15-6></a>TypeError:<span class=w> </span>only<span class=w> </span>integer<span class=w> </span>scalar<span class=w> </span>arrays<span class=w> </span>can<span class=w> </span>be<span class=w> </span>converted<span class=w> </span>to<span class=w> </span>a<span class=w> </span>scalar<span class=w> </span>index
</span></code></pre></div><p>然后由于每次运行，<em>计算 SHAP 值</em> 都需要等几分钟(不方便测试 <code>summary_plot</code> )，所以想把 <code>shap_values</code> 保存成二进制文件，就可以直接加载不需要再次运算(但不清楚具体操作方法)，所以询问chatgpt<details class=example open><summary>对话记录</summary> <p>You:</p> <p>i want to save a variable to a binary file in python, how should i do?</p> <p> </p> <p>ChatGPT:</p> <p>You can save a variable to a binary file in Python using the <code>pickle</code> module. Here's a simple example:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-16-1><a href=#__codelineno-16-1 id=__codelineno-16-1 name=__codelineno-16-1></a><span class=kn>import</span><span class=w> </span><span class=nn>pickle</span>
</span><span id=__span-16-2><a href=#__codelineno-16-2 id=__codelineno-16-2 name=__codelineno-16-2></a>
</span><span id=__span-16-3><a href=#__codelineno-16-3 id=__codelineno-16-3 name=__codelineno-16-3></a><span class=c1># Define your variable</span>
</span><span id=__span-16-4><a href=#__codelineno-16-4 id=__codelineno-16-4 name=__codelineno-16-4></a><span class=n>data</span> <span class=o>=</span> <span class=p>{</span><span class=s1>'name'</span><span class=p>:</span> <span class=s1>'John'</span><span class=p>,</span> <span class=s1>'age'</span><span class=p>:</span> <span class=mi>30</span><span class=p>,</span> <span class=s1>'city'</span><span class=p>:</span> <span class=s1>'New York'</span><span class=p>}</span>
</span><span id=__span-16-5><a href=#__codelineno-16-5 id=__codelineno-16-5 name=__codelineno-16-5></a>
</span><span id=__span-16-6><a href=#__codelineno-16-6 id=__codelineno-16-6 name=__codelineno-16-6></a><span class=c1># Open a file in binary mode</span>
</span><span id=__span-16-7><a href=#__codelineno-16-7 id=__codelineno-16-7 name=__codelineno-16-7></a><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>'data.bin'</span><span class=p>,</span> <span class=s1>'wb'</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span><span id=__span-16-8><a href=#__codelineno-16-8 id=__codelineno-16-8 name=__codelineno-16-8></a>    <span class=c1># Dump the variable to the file</span>
</span><span id=__span-16-9><a href=#__codelineno-16-9 id=__codelineno-16-9 name=__codelineno-16-9></a>    <span class=n>pickle</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>f</span><span class=p>)</span>
</span></code></pre></div> <p>This code saves the <code>data</code> variable to a binary file named <code>'data.bin'</code>. You can then load this variable back from the file using <code>pickle.load()</code> function. Remember to always open the file in binary mode (<code>'rb'</code> for reading and <code>'wb'</code> for writing) when working with binary files.</p></details><p>于是仿照chatgpt提供的代码，将 <code>shap_values</code> 保存成了 <code>shap_values.bin</code><div class="language-python highlight"><pre><span></span><code><span id=__span-17-1><a href=#__codelineno-17-1 id=__codelineno-17-1 name=__codelineno-17-1></a><span class=c1># 将 `shap_values` 保存为二进制文件</span>
</span><span id=__span-17-2><a href=#__codelineno-17-2 id=__codelineno-17-2 name=__codelineno-17-2></a><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>'shap_values.bin'</span><span class=p>,</span> <span class=s1>'wb'</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span><span id=__span-17-3><a href=#__codelineno-17-3 id=__codelineno-17-3 name=__codelineno-17-3></a>    <span class=n>pickle</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>shap_values</span><span class=p>,</span> <span class=n>f</span><span class=p>)</span>
</span></code></pre></div><blockquote><p>读取这个二进制文件的方法为<div class="language-python highlight"><pre><span></span><code><span id=__span-18-1><a href=#__codelineno-18-1 id=__codelineno-18-1 name=__codelineno-18-1></a><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>'shap_values.bin'</span><span class=p>,</span> <span class=s1>'rb'</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span><span id=__span-18-2><a href=#__codelineno-18-2 id=__codelineno-18-2 name=__codelineno-18-2></a>    <span class=n>shap_values</span> <span class=o>=</span> <span class=n>pickle</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
</span></code></pre></div></blockquote><hr><blockquote><p>其间发现 <code>shap_values</code> 的类型是 <code>shap._explanation.Explanation</code></blockquote><hr><p>由于一直尝试无果后，去查看<a href=https://github.com/shap/shap/>官方仓库 README.md</a>，<blockquote><p>过程中发现，无论是github copilot 、 chatgpt 还是 bing，似乎对 <code>shap</code> 包的使用，在给出的回答中的代码都不是很正确，我个人猜测可能是由于这个包比较新的原因(？)，并且也感到反而bing给出的回答似乎更加正确一些，<p>所以最后还是决定自己去查看官方的说明</blockquote><p>发现应该参照 <a href=https://github.com/shap/shap/#deep-learning-example-with-deepexplainer-tensorflowkeras-models><code>Deep learning example with DeepExplainer (TensorFlow/Keras models)</code></a> 处的代码结构，并且应该使用的(解释器)是 <code>shap.DeepExplainer</code> ，于是<div class="language-python highlight"><table class=highlighttable><tr><th class=filename colspan=2><span class=filename>shap_tf.py</span><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-19-1> 1</a></span>
<span class=normal><a href=#__codelineno-19-2> 2</a></span>
<span class=normal><a href=#__codelineno-19-3> 3</a></span>
<span class=normal><a href=#__codelineno-19-4> 4</a></span>
<span class=normal><a href=#__codelineno-19-5> 5</a></span>
<span class=normal><a href=#__codelineno-19-6> 6</a></span>
<span class=normal><a href=#__codelineno-19-7> 7</a></span>
<span class=normal><a href=#__codelineno-19-8> 8</a></span>
<span class=normal><a href=#__codelineno-19-9> 9</a></span>
<span class=normal><a href=#__codelineno-19-10>10</a></span>
<span class=normal><a href=#__codelineno-19-11>11</a></span>
<span class=normal><a href=#__codelineno-19-12>12</a></span>
<span class=normal><a href=#__codelineno-19-13>13</a></span>
<span class=normal><a href=#__codelineno-19-14>14</a></span>
<span class=normal><a href=#__codelineno-19-15>15</a></span>
<span class=normal><a href=#__codelineno-19-16>16</a></span>
<span class=normal><a href=#__codelineno-19-17>17</a></span>
<span class=normal><a href=#__codelineno-19-18>18</a></span>
<span class=normal><a href=#__codelineno-19-19>19</a></span>
<span class=normal><a href=#__codelineno-19-20>20</a></span>
<span class=normal><a href=#__codelineno-19-21>21</a></span>
<span class=normal><a href=#__codelineno-19-22>22</a></span>
<span class=normal><a href=#__codelineno-19-23>23</a></span></pre></div><td class=code><div><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1></a><span class=kn>import</span><span class=w> </span><span class=nn>shap</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2></a><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3></a><span class=kn>from</span><span class=w> </span><span class=nn>train_data</span><span class=w> </span><span class=kn>import</span> <span class=n>preprocess</span><span class=p>,</span> <span class=n>build_model</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4></a>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5></a><span class=c1># read and preprocess data</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6></a><span class=n>data</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s1>'merged_data.npy'</span><span class=p>,</span> <span class=n>allow_pickle</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7></a><span class=n>X_train</span><span class=p>,</span> <span class=n>X_test</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>preprocess</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8></a>
</span><span id=__span-19-9><a id=__codelineno-19-9 name=__codelineno-19-9></a><span class=c1># select a set of background examples to take an expectation over</span>
</span><span id=__span-19-10><a id=__codelineno-19-10 name=__codelineno-19-10></a><span class=n>background</span> <span class=o>=</span> <span class=n>X_train</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>X_train</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>100</span><span class=p>,</span> <span class=n>replace</span><span class=o>=</span><span class=kc>False</span><span class=p>)]</span>
</span><span id=__span-19-11><a id=__codelineno-19-11 name=__codelineno-19-11></a>
</span><span id=__span-19-12><a id=__codelineno-19-12 name=__codelineno-19-12></a><span class=c1># build model</span>
</span><span id=__span-19-13><a id=__codelineno-19-13 name=__codelineno-19-13></a><span class=n>model</span> <span class=o>=</span> <span class=n>build_model</span><span class=p>(</span><span class=n>X_train</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span><span id=__span-19-14><a id=__codelineno-19-14 name=__codelineno-19-14></a><span class=n>model</span><span class=o>.</span><span class=n>load_weights</span><span class=p>(</span><span class=s1>'model_400.h5'</span><span class=p>)</span>
</span><span id=__span-19-15><a id=__codelineno-19-15 name=__codelineno-19-15></a>
</span><span id=__span-19-16><a id=__codelineno-19-16 name=__codelineno-19-16></a><span class=c1># Assuming 'model' is your deep learning model and 'background' is a sample of your input data</span>
</span><span id=__span-19-17><a id=__codelineno-19-17 name=__codelineno-19-17></a><span class=n>explainer</span> <span class=o>=</span> <span class=n>shap</span><span class=o>.</span><span class=n>DeepExplainer</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>background</span><span class=p>)</span>
</span><span id=__span-19-18><a id=__codelineno-19-18 name=__codelineno-19-18></a>
</span><span id=__span-19-19><a id=__codelineno-19-19 name=__codelineno-19-19></a><span class=c1># 'test_data' is the data you want to explain</span>
</span><span id=__span-19-20><a id=__codelineno-19-20 name=__codelineno-19-20></a><span class=n>shap_values</span> <span class=o>=</span> <span class=n>explainer</span><span class=o>.</span><span class=n>shap_values</span><span class=p>(</span><span class=n>X_test</span><span class=p>)</span>
</span><span id=__span-19-21><a id=__codelineno-19-21 name=__codelineno-19-21></a>
</span><span id=__span-19-22><a id=__codelineno-19-22 name=__codelineno-19-22></a><span class=c1># plot the feature attributions</span>
</span><span id=__span-19-23><a id=__codelineno-19-23 name=__codelineno-19-23></a><span class=n>shap</span><span class=o>.</span><span class=n>image_plot</span><span class=p>(</span><span class=n>shap_values</span><span class=p>,</span> <span class=o>-</span><span class=n>X_test</span><span class=p>[:])</span>
</span></code></pre></div></table></div><p>但是在运行时，先是显示<div class="language-bash highlight"><pre><span></span><code><span id=__span-20-1><a href=#__codelineno-20-1 id=__codelineno-20-1 name=__codelineno-20-1></a>Traceback<span class=w> </span><span class=o>(</span>most<span class=w> </span>recent<span class=w> </span>call<span class=w> </span>last<span class=o>)</span>:
</span><span id=__span-20-2><a href=#__codelineno-20-2 id=__codelineno-20-2 name=__codelineno-20-2></a><span class=w>  </span>File<span class=w> </span><span class=s2>"c:\PycharmProjects\NPUCM24\shap_tf.py"</span>,<span class=w> </span>line<span class=w> </span><span class=m>17</span>,<span class=w> </span><span class=k>in</span><span class=w> </span>&lt;module>
</span><span id=__span-20-3><a href=#__codelineno-20-3 id=__codelineno-20-3 name=__codelineno-20-3></a><span class=w>    </span><span class=nv>explainer</span><span class=w> </span><span class=o>=</span><span class=w> </span>shap.DeepExplainer<span class=o>(</span>model,<span class=w> </span>background<span class=o>)</span>
</span><span id=__span-20-4><a href=#__codelineno-20-4 id=__codelineno-20-4 name=__codelineno-20-4></a><span class=w>  </span>File<span class=w> </span><span class=s2>"C:\Users\Ronald\AppData\Local\Programs\Python\Python310\lib\site-packages\shap\explainers\_deep\__init__.py"</span>,<span class=w> </span>line<span class=w> </span><span class=m>84</span>,<span class=w> </span><span class=k>in</span><span class=w> </span>__init__
</span><span id=__span-20-5><a href=#__codelineno-20-5 id=__codelineno-20-5 name=__codelineno-20-5></a><span class=w>    </span>self.explainer<span class=w> </span><span class=o>=</span><span class=w> </span>TFDeep<span class=o>(</span>model,<span class=w> </span>data,<span class=w> </span>session,<span class=w> </span>learning_phase_flags<span class=o>)</span>
</span><span id=__span-20-6><a href=#__codelineno-20-6 id=__codelineno-20-6 name=__codelineno-20-6></a><span class=w>  </span>File<span class=w> </span><span class=s2>"C:\Users\Ronald\AppData\Local\Programs\Python\Python310\lib\site-packages\shap\explainers\_deep\deep_tf.py"</span>,<span class=w> </span>line<span class=w> </span><span class=m>172</span>,<span class=w> </span><span class=k>in</span><span class=w> </span>__init__
</span><span id=__span-20-7><a href=#__codelineno-20-7 id=__codelineno-20-7 name=__codelineno-20-7></a><span class=w>    </span><span class=nv>noutputs</span><span class=w> </span><span class=o>=</span><span class=w> </span>self.model_output.shape.as_list<span class=o>()[</span><span class=m>1</span><span class=o>]</span>
</span><span id=__span-20-8><a href=#__codelineno-20-8 id=__codelineno-20-8 name=__codelineno-20-8></a>AttributeError:<span class=w> </span><span class=s1>'tuple'</span><span class=w> </span>object<span class=w> </span>has<span class=w> </span>no<span class=w> </span>attribute<span class=w> </span><span class=s1>'as_list'</span>
</span></code></pre></div><p>尝试之后认为应该是 <code>shap</code> 包的问题，所以修改它的代码<div class="language-python highlight"><table class=highlighttable><tr><th class=filename colspan=2><span class=filename>.../_deep/deep_tf.py</span><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-21-172>172</a></span>
<span class=normal><a href=#__codelineno-21-173>173</a></span></pre></div><td class=code><div><pre><span></span><code><span id=__span-21-172><a id=__codelineno-21-172 name=__codelineno-21-172></a><span class=c1># noutputs = self.model_output.shape.as_list()[1]</span>
</span><span id=__span-21-173><a id=__codelineno-21-173 name=__codelineno-21-173></a><span class=hll><span class=n>noutputs</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>model_output</span><span class=o>.</span><span class=n>shape</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>
</span></span></code></pre></div></table></div><p>再次运行，原报错消失，但出现新的报错<div class="language-bash highlight"><pre><span></span><code><span id=__span-22-1><a href=#__codelineno-22-1 id=__codelineno-22-1 name=__codelineno-22-1></a>Traceback<span class=w> </span><span class=o>(</span>most<span class=w> </span>recent<span class=w> </span>call<span class=w> </span>last<span class=o>)</span>:
</span><span id=__span-22-2><a href=#__codelineno-22-2 id=__codelineno-22-2 name=__codelineno-22-2></a><span class=w>  </span>File<span class=w> </span><span class=s2>"c:\PycharmProjects\NPUCM24\shap_tf.py"</span>,<span class=w> </span>line<span class=w> </span><span class=m>20</span>,<span class=w> </span><span class=k>in</span><span class=w> </span>&lt;module>
</span><span id=__span-22-3><a href=#__codelineno-22-3 id=__codelineno-22-3 name=__codelineno-22-3></a><span class=w>    </span><span class=nv>shap_values</span><span class=w> </span><span class=o>=</span><span class=w> </span>explainer.shap_values<span class=o>(</span>X_test<span class=o>)</span>
</span><span id=__span-22-4><a href=#__codelineno-22-4 id=__codelineno-22-4 name=__codelineno-22-4></a><span class=w>  </span>...
</span><span id=__span-22-5><a href=#__codelineno-22-5 id=__codelineno-22-5 name=__codelineno-22-5></a><span class=w>  </span>File<span class=w> </span><span class=s2>"C:\Users\Ronald\AppData\Local\Temp\__autograph_generated_file4ldlekdk.py"</span>,<span class=w> </span>line<span class=w> </span><span class=m>12</span>,<span class=w> </span><span class=k>in</span><span class=w> </span>tf__grad_graph
</span><span id=__span-22-6><a href=#__codelineno-22-6 id=__codelineno-22-6 name=__codelineno-22-6></a><span class=w>    </span><span class=nv>phase</span><span class=w> </span><span class=o>=</span><span class=w> </span>ag__.converted_call<span class=o>(</span>ag__.ld<span class=o>(</span>tf<span class=o>)</span>.keras.backend.learning_phase,<span class=w> </span><span class=o>()</span>,<span class=w> </span>None,<span class=w> </span>fscope<span class=o>)</span>
</span><span id=__span-22-7><a href=#__codelineno-22-7 id=__codelineno-22-7 name=__codelineno-22-7></a>AttributeError:<span class=w> </span><span class=k>in</span><span class=w> </span>user<span class=w> </span>code:
</span><span id=__span-22-8><a href=#__codelineno-22-8 id=__codelineno-22-8 name=__codelineno-22-8></a>
</span><span id=__span-22-9><a href=#__codelineno-22-9 id=__codelineno-22-9 name=__codelineno-22-9></a><span class=w>    </span>File<span class=w> </span><span class=s2>"C:\Users\Ronald\AppData\Local\Programs\Python\Python310\lib\site-packages\shap\explainers\_deep\deep_tf.py"</span>,<span class=w> </span>line<span class=w> </span><span class=m>240</span>,<span class=w> </span><span class=k>in</span><span class=w> </span>grad_graph<span class=w>  </span>*
</span><span id=__span-22-10><a href=#__codelineno-22-10 id=__codelineno-22-10 name=__codelineno-22-10></a><span class=w>        </span><span class=nv>phase</span><span class=w> </span><span class=o>=</span><span class=w> </span>tf.keras.backend.learning_phase<span class=o>()</span>
</span><span id=__span-22-11><a href=#__codelineno-22-11 id=__codelineno-22-11 name=__codelineno-22-11></a>
</span><span id=__span-22-12><a href=#__codelineno-22-12 id=__codelineno-22-12 name=__codelineno-22-12></a><span class=w>    </span>AttributeError:<span class=w> </span>module<span class=w> </span><span class=s1>'keras._tf_keras.keras.backend'</span><span class=w> </span>has<span class=w> </span>no<span class=w> </span>attribute<span class=w> </span><span class=s1>'learning_phase'</span>
</span></code></pre></div><p>好像又是包本身代码的问题，询问copilot如何解决<details class=example open><summary>对话记录</summary> <p>RonaldLN:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-23-1><a href=#__codelineno-23-1 id=__codelineno-23-1 name=__codelineno-23-1></a>AttributeError:<span class=w> </span>module<span class=w> </span><span class=s1>'keras._tf_keras.keras.backend'</span><span class=w> </span>has<span class=w> </span>no<span class=w> </span>attribute<span class=w> </span><span class=s1>'learning_phase'</span>
</span></code></pre></div> <p> </p> <p>Github Copilot:</p> <p>这个错误是因为你试图访问<code>keras._tf_keras.keras.backend</code>模块中不存在的<code>learning_phase</code>属性。这可能是因为你使用的Keras版本与代码中使用的版本不兼容。</p> <p>在TensorFlow 2.x和新版本的Keras中，<code>learning_phase</code>已经被移除。在训练和预测模式下，模型的行为现在由内置的Keras方法（如<code>fit</code>、<code>evaluate</code>和<code>predict</code>）自动管理。</p> <p>如果你的代码依赖于<code>learning_phase</code>，你可能需要更新你的代码以适应新版本的Keras和TensorFlow。具体来说，你可能需要移除所有引用<code>learning_phase</code>的代码，并确保你的模型在训练和预测时使用正确的方法。</p> <p>如果你不能修改代码，另一个解决方案是降级你的Keras和TensorFlow版本到一个包含<code>learning_phase</code>的版本。你可以使用如下命令来安装特定版本的Keras和TensorFlow：</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-24-1><a href=#__codelineno-24-1 id=__codelineno-24-1 name=__codelineno-24-1></a>pip<span class=w> </span>install<span class=w> </span><span class=nv>keras</span><span class=o>==</span>&lt;version><span class=w> </span><span class=nv>tensorflow</span><span class=o>==</span>&lt;version>
</span></code></pre></div> <p>你需要将<code>&lt;version></code>替换为你想要安装的版本号。</p></details><hr><p>感觉这个问题不是很好解决，<p>于是就想试试换成用PyTorch来搭建MLP模型并训练，看看pytorch的模型能不能正常跑，<p>于是让copilot转换 <code>train_data.py</code><details class=example open><summary>对话记录</summary> <p>SeazSu:</p> <p>你可以帮我将 <code>train_data.py</code> 中的代码改写成用pytorch来实现吗？</p> <p> </p> <p>GitHub Copilot:</p> <details class=quote><summary>已使用 1 引用</summary> <ul><li>train_data.py: 1-149</ul></details> <p>当然可以，以下是使用PyTorch重写的代码：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-25-1><a href=#__codelineno-25-1 id=__codelineno-25-1 name=__codelineno-25-1></a><span class=c1># 使用PyTorch搭建一个MLP模型，用于训练数据</span>
</span><span id=__span-25-2><a href=#__codelineno-25-2 id=__codelineno-25-2 name=__codelineno-25-2></a>
</span><span id=__span-25-3><a href=#__codelineno-25-3 id=__codelineno-25-3 name=__codelineno-25-3></a><span class=kn>import</span><span class=w> </span><span class=nn>torch</span>
</span><span id=__span-25-4><a href=#__codelineno-25-4 id=__codelineno-25-4 name=__codelineno-25-4></a><span class=kn>import</span><span class=w> </span><span class=nn>torch.nn</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>nn</span>
</span><span id=__span-25-5><a href=#__codelineno-25-5 id=__codelineno-25-5 name=__codelineno-25-5></a><span class=kn>import</span><span class=w> </span><span class=nn>torch.optim</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>optim</span>
</span><span id=__span-25-6><a href=#__codelineno-25-6 id=__codelineno-25-6 name=__codelineno-25-6></a><span class=kn>from</span><span class=w> </span><span class=nn>torch.utils.data</span><span class=w> </span><span class=kn>import</span> <span class=n>TensorDataset</span><span class=p>,</span> <span class=n>DataLoader</span>
</span><span id=__span-25-7><a href=#__codelineno-25-7 id=__codelineno-25-7 name=__codelineno-25-7></a><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
</span><span id=__span-25-8><a href=#__codelineno-25-8 id=__codelineno-25-8 name=__codelineno-25-8></a><span class=kn>from</span><span class=w> </span><span class=nn>sklearn.model_selection</span><span class=w> </span><span class=kn>import</span> <span class=n>train_test_split</span>
</span><span id=__span-25-9><a href=#__codelineno-25-9 id=__codelineno-25-9 name=__codelineno-25-9></a><span class=kn>from</span><span class=w> </span><span class=nn>sklearn.preprocessing</span><span class=w> </span><span class=kn>import</span> <span class=n>StandardScaler</span>
</span><span id=__span-25-10><a href=#__codelineno-25-10 id=__codelineno-25-10 name=__codelineno-25-10></a><span class=kn>from</span><span class=w> </span><span class=nn>sklearn.metrics</span><span class=w> </span><span class=kn>import</span> <span class=n>accuracy_score</span>
</span><span id=__span-25-11><a href=#__codelineno-25-11 id=__codelineno-25-11 name=__codelineno-25-11></a><span class=kn>from</span><span class=w> </span><span class=nn>sklearn.metrics</span><span class=w> </span><span class=kn>import</span> <span class=n>confusion_matrix</span>
</span><span id=__span-25-12><a href=#__codelineno-25-12 id=__codelineno-25-12 name=__codelineno-25-12></a><span class=kn>from</span><span class=w> </span><span class=nn>sklearn.metrics</span><span class=w> </span><span class=kn>import</span> <span class=n>classification_report</span>
</span><span id=__span-25-13><a href=#__codelineno-25-13 id=__codelineno-25-13 name=__codelineno-25-13></a><span class=kn>from</span><span class=w> </span><span class=nn>sklearn.utils</span><span class=w> </span><span class=kn>import</span> <span class=n>shuffle</span>
</span><span id=__span-25-14><a href=#__codelineno-25-14 id=__codelineno-25-14 name=__codelineno-25-14></a>
</span><span id=__span-25-15><a href=#__codelineno-25-15 id=__codelineno-25-15 name=__codelineno-25-15></a><span class=c1># 读取数据</span>
</span><span id=__span-25-16><a href=#__codelineno-25-16 id=__codelineno-25-16 name=__codelineno-25-16></a><span class=k>def</span><span class=w> </span><span class=nf>read_data</span><span class=p>():</span>
</span><span id=__span-25-17><a href=#__codelineno-25-17 id=__codelineno-25-17 name=__codelineno-25-17></a>    <span class=c1># ... 代码保持不变 ...</span>
</span><span id=__span-25-18><a href=#__codelineno-25-18 id=__codelineno-25-18 name=__codelineno-25-18></a>
</span><span id=__span-25-19><a href=#__codelineno-25-19 id=__codelineno-25-19 name=__codelineno-25-19></a><span class=c1># 将3个array数组合并</span>
</span><span id=__span-25-20><a href=#__codelineno-25-20 id=__codelineno-25-20 name=__codelineno-25-20></a><span class=k>def</span><span class=w> </span><span class=nf>merge_data</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
</span><span id=__span-25-21><a href=#__codelineno-25-21 id=__codelineno-25-21 name=__codelineno-25-21></a>    <span class=c1># ... 代码保持不变 ...</span>
</span><span id=__span-25-22><a href=#__codelineno-25-22 id=__codelineno-25-22 name=__codelineno-25-22></a>
</span><span id=__span-25-23><a href=#__codelineno-25-23 id=__codelineno-25-23 name=__codelineno-25-23></a><span class=c1># 数据预处理</span>
</span><span id=__span-25-24><a href=#__codelineno-25-24 id=__codelineno-25-24 name=__codelineno-25-24></a><span class=k>def</span><span class=w> </span><span class=nf>preprocess</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
</span><span id=__span-25-25><a href=#__codelineno-25-25 id=__codelineno-25-25 name=__codelineno-25-25></a>    <span class=c1># ... 代码保持不变 ...</span>
</span><span id=__span-25-26><a href=#__codelineno-25-26 id=__codelineno-25-26 name=__codelineno-25-26></a>
</span><span id=__span-25-27><a href=#__codelineno-25-27 id=__codelineno-25-27 name=__codelineno-25-27></a>    <span class=c1># 将数据转换为PyTorch张量</span>
</span><span id=__span-25-28><a href=#__codelineno-25-28 id=__codelineno-25-28 name=__codelineno-25-28></a>    <span class=n>X_train</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>from_numpy</span><span class=p>(</span><span class=n>X_train</span><span class=p>)</span>
</span><span id=__span-25-29><a href=#__codelineno-25-29 id=__codelineno-25-29 name=__codelineno-25-29></a>    <span class=n>X_test</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>from_numpy</span><span class=p>(</span><span class=n>X_test</span><span class=p>)</span>
</span><span id=__span-25-30><a href=#__codelineno-25-30 id=__codelineno-25-30 name=__codelineno-25-30></a>    <span class=n>y_train</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>from_numpy</span><span class=p>(</span><span class=n>y_train</span><span class=p>)</span>
</span><span id=__span-25-31><a href=#__codelineno-25-31 id=__codelineno-25-31 name=__codelineno-25-31></a>    <span class=n>y_test</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>from_numpy</span><span class=p>(</span><span class=n>y_test</span><span class=p>)</span>
</span><span id=__span-25-32><a href=#__codelineno-25-32 id=__codelineno-25-32 name=__codelineno-25-32></a>
</span><span id=__span-25-33><a href=#__codelineno-25-33 id=__codelineno-25-33 name=__codelineno-25-33></a>    <span class=k>return</span> <span class=n>X_train</span><span class=p>,</span> <span class=n>X_test</span><span class=p>,</span> <span class=n>y_train</span><span class=p>,</span> <span class=n>y_test</span>
</span><span id=__span-25-34><a href=#__codelineno-25-34 id=__codelineno-25-34 name=__codelineno-25-34></a>
</span><span id=__span-25-35><a href=#__codelineno-25-35 id=__codelineno-25-35 name=__codelineno-25-35></a><span class=c1># 构建MLP模型</span>
</span><span id=__span-25-36><a href=#__codelineno-25-36 id=__codelineno-25-36 name=__codelineno-25-36></a><span class=k>class</span><span class=w> </span><span class=nc>MLP</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span><span id=__span-25-37><a href=#__codelineno-25-37 id=__codelineno-25-37 name=__codelineno-25-37></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>input_shape</span><span class=p>):</span>
</span><span id=__span-25-38><a href=#__codelineno-25-38 id=__codelineno-25-38 name=__codelineno-25-38></a>        <span class=nb>super</span><span class=p>(</span><span class=n>MLP</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span><span id=__span-25-39><a href=#__codelineno-25-39 id=__codelineno-25-39 name=__codelineno-25-39></a>        <span class=bp>self</span><span class=o>.</span><span class=n>layers</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Sequential</span><span class=p>(</span>
</span><span id=__span-25-40><a href=#__codelineno-25-40 id=__codelineno-25-40 name=__codelineno-25-40></a>            <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span><span class=n>input_shape</span><span class=p>,</span> <span class=mi>128</span><span class=p>),</span>
</span><span id=__span-25-41><a href=#__codelineno-25-41 id=__codelineno-25-41 name=__codelineno-25-41></a>            <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(),</span>
</span><span id=__span-25-42><a href=#__codelineno-25-42 id=__codelineno-25-42 name=__codelineno-25-42></a>            <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span><span class=mi>128</span><span class=p>,</span> <span class=mi>64</span><span class=p>),</span>
</span><span id=__span-25-43><a href=#__codelineno-25-43 id=__codelineno-25-43 name=__codelineno-25-43></a>            <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(),</span>
</span><span id=__span-25-44><a href=#__codelineno-25-44 id=__codelineno-25-44 name=__codelineno-25-44></a>            <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span><span class=mi>64</span><span class=p>,</span> <span class=mi>32</span><span class=p>),</span>
</span><span id=__span-25-45><a href=#__codelineno-25-45 id=__codelineno-25-45 name=__codelineno-25-45></a>            <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(),</span>
</span><span id=__span-25-46><a href=#__codelineno-25-46 id=__codelineno-25-46 name=__codelineno-25-46></a>            <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span><span class=mi>32</span><span class=p>,</span> <span class=mi>3</span><span class=p>),</span>
</span><span id=__span-25-47><a href=#__codelineno-25-47 id=__codelineno-25-47 name=__codelineno-25-47></a>            <span class=n>nn</span><span class=o>.</span><span class=n>Softmax</span><span class=p>(</span><span class=n>dim</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-25-48><a href=#__codelineno-25-48 id=__codelineno-25-48 name=__codelineno-25-48></a>        <span class=p>)</span>
</span><span id=__span-25-49><a href=#__codelineno-25-49 id=__codelineno-25-49 name=__codelineno-25-49></a>
</span><span id=__span-25-50><a href=#__codelineno-25-50 id=__codelineno-25-50 name=__codelineno-25-50></a>    <span class=k>def</span><span class=w> </span><span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>):</span>
</span><span id=__span-25-51><a href=#__codelineno-25-51 id=__codelineno-25-51 name=__codelineno-25-51></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>layers</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span><span id=__span-25-52><a href=#__codelineno-25-52 id=__codelineno-25-52 name=__codelineno-25-52></a>
</span><span id=__span-25-53><a href=#__codelineno-25-53 id=__codelineno-25-53 name=__codelineno-25-53></a><span class=c1># 训练模型</span>
</span><span id=__span-25-54><a href=#__codelineno-25-54 id=__codelineno-25-54 name=__codelineno-25-54></a><span class=k>def</span><span class=w> </span><span class=nf>train_model</span><span class=p>(</span><span class=n>X_train</span><span class=p>,</span> <span class=n>y_train</span><span class=p>,</span> <span class=n>epochs</span><span class=p>):</span>
</span><span id=__span-25-55><a href=#__codelineno-25-55 id=__codelineno-25-55 name=__codelineno-25-55></a>    <span class=n>model</span> <span class=o>=</span> <span class=n>MLP</span><span class=p>(</span><span class=n>X_train</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span><span id=__span-25-56><a href=#__codelineno-25-56 id=__codelineno-25-56 name=__codelineno-25-56></a>    <span class=n>criterion</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>CrossEntropyLoss</span><span class=p>()</span>
</span><span id=__span-25-57><a href=#__codelineno-25-57 id=__codelineno-25-57 name=__codelineno-25-57></a>    <span class=n>optimizer</span> <span class=o>=</span> <span class=n>optim</span><span class=o>.</span><span class=n>Adam</span><span class=p>(</span><span class=n>model</span><span class=o>.</span><span class=n>parameters</span><span class=p>())</span>
</span><span id=__span-25-58><a href=#__codelineno-25-58 id=__codelineno-25-58 name=__codelineno-25-58></a>
</span><span id=__span-25-59><a href=#__codelineno-25-59 id=__codelineno-25-59 name=__codelineno-25-59></a>    <span class=n>dataset</span> <span class=o>=</span> <span class=n>TensorDataset</span><span class=p>(</span><span class=n>X_train</span><span class=p>,</span> <span class=n>y_train</span><span class=p>)</span>
</span><span id=__span-25-60><a href=#__codelineno-25-60 id=__codelineno-25-60 name=__codelineno-25-60></a>    <span class=n>dataloader</span> <span class=o>=</span> <span class=n>DataLoader</span><span class=p>(</span><span class=n>dataset</span><span class=p>,</span> <span class=n>batch_size</span><span class=o>=</span><span class=mi>32</span><span class=p>,</span> <span class=n>shuffle</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-25-61><a href=#__codelineno-25-61 id=__codelineno-25-61 name=__codelineno-25-61></a>
</span><span id=__span-25-62><a href=#__codelineno-25-62 id=__codelineno-25-62 name=__codelineno-25-62></a>    <span class=k>for</span> <span class=n>epoch</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>epochs</span><span class=p>):</span>
</span><span id=__span-25-63><a href=#__codelineno-25-63 id=__codelineno-25-63 name=__codelineno-25-63></a>        <span class=k>for</span> <span class=n>inputs</span><span class=p>,</span> <span class=n>targets</span> <span class=ow>in</span> <span class=n>dataloader</span><span class=p>:</span>
</span><span id=__span-25-64><a href=#__codelineno-25-64 id=__codelineno-25-64 name=__codelineno-25-64></a>            <span class=n>optimizer</span><span class=o>.</span><span class=n>zero_grad</span><span class=p>()</span>
</span><span id=__span-25-65><a href=#__codelineno-25-65 id=__codelineno-25-65 name=__codelineno-25-65></a>            <span class=n>outputs</span> <span class=o>=</span> <span class=n>model</span><span class=p>(</span><span class=n>inputs</span><span class=p>)</span>
</span><span id=__span-25-66><a href=#__codelineno-25-66 id=__codelineno-25-66 name=__codelineno-25-66></a>            <span class=n>loss</span> <span class=o>=</span> <span class=n>criterion</span><span class=p>(</span><span class=n>outputs</span><span class=p>,</span> <span class=n>targets</span><span class=p>)</span>
</span><span id=__span-25-67><a href=#__codelineno-25-67 id=__codelineno-25-67 name=__codelineno-25-67></a>            <span class=n>loss</span><span class=o>.</span><span class=n>backward</span><span class=p>()</span>
</span><span id=__span-25-68><a href=#__codelineno-25-68 id=__codelineno-25-68 name=__codelineno-25-68></a>            <span class=n>optimizer</span><span class=o>.</span><span class=n>step</span><span class=p>()</span>
</span><span id=__span-25-69><a href=#__codelineno-25-69 id=__codelineno-25-69 name=__codelineno-25-69></a>
</span><span id=__span-25-70><a href=#__codelineno-25-70 id=__codelineno-25-70 name=__codelineno-25-70></a>    <span class=k>return</span> <span class=n>model</span>
</span><span id=__span-25-71><a href=#__codelineno-25-71 id=__codelineno-25-71 name=__codelineno-25-71></a>
</span><span id=__span-25-72><a href=#__codelineno-25-72 id=__codelineno-25-72 name=__codelineno-25-72></a><span class=c1># 评估模型</span>
</span><span id=__span-25-73><a href=#__codelineno-25-73 id=__codelineno-25-73 name=__codelineno-25-73></a><span class=k>def</span><span class=w> </span><span class=nf>evaluate_model</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>X_test</span><span class=p>,</span> <span class=n>y_test</span><span class=p>):</span>
</span><span id=__span-25-74><a href=#__codelineno-25-74 id=__codelineno-25-74 name=__codelineno-25-74></a>    <span class=k>with</span> <span class=n>torch</span><span class=o>.</span><span class=n>no_grad</span><span class=p>():</span>
</span><span id=__span-25-75><a href=#__codelineno-25-75 id=__codelineno-25-75 name=__codelineno-25-75></a>        <span class=n>outputs</span> <span class=o>=</span> <span class=n>model</span><span class=p>(</span><span class=n>X_test</span><span class=p>)</span>
</span><span id=__span-25-76><a href=#__codelineno-25-76 id=__codelineno-25-76 name=__codelineno-25-76></a>        <span class=n>_</span><span class=p>,</span> <span class=n>y_pred</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>max</span><span class=p>(</span><span class=n>outputs</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span><span id=__span-25-77><a href=#__codelineno-25-77 id=__codelineno-25-77 name=__codelineno-25-77></a>
</span><span id=__span-25-78><a href=#__codelineno-25-78 id=__codelineno-25-78 name=__codelineno-25-78></a>    <span class=c1># ... 代码保持不变 ...</span>
</span><span id=__span-25-79><a href=#__codelineno-25-79 id=__codelineno-25-79 name=__codelineno-25-79></a>
</span><span id=__span-25-80><a href=#__codelineno-25-80 id=__codelineno-25-80 name=__codelineno-25-80></a><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>'__main__'</span><span class=p>:</span>
</span><span id=__span-25-81><a href=#__codelineno-25-81 id=__codelineno-25-81 name=__codelineno-25-81></a>    <span class=c1># data = read_data()</span>
</span><span id=__span-25-82><a href=#__codelineno-25-82 id=__codelineno-25-82 name=__codelineno-25-82></a>    <span class=c1># data = merge_data(data)</span>
</span><span id=__span-25-83><a href=#__codelineno-25-83 id=__codelineno-25-83 name=__codelineno-25-83></a>    <span class=n>data</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s1>'merged_data.npy'</span><span class=p>,</span> <span class=n>allow_pickle</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-25-84><a href=#__codelineno-25-84 id=__codelineno-25-84 name=__codelineno-25-84></a>    <span class=n>X_train</span><span class=p>,</span> <span class=n>X_test</span><span class=p>,</span> <span class=n>y_train</span><span class=p>,</span> <span class=n>y_test</span> <span class=o>=</span> <span class=n>preprocess</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-25-85><a href=#__codelineno-25-85 id=__codelineno-25-85 name=__codelineno-25-85></a>    <span class=n>epochs</span> <span class=o>=</span> <span class=mi>400</span>
</span><span id=__span-25-86><a href=#__codelineno-25-86 id=__codelineno-25-86 name=__codelineno-25-86></a>    <span class=n>model</span> <span class=o>=</span> <span class=n>train_model</span><span class=p>(</span><span class=n>X_train</span><span class=p>,</span> <span class=n>y_train</span><span class=p>,</span> <span class=n>epochs</span><span class=p>)</span>
</span><span id=__span-25-87><a href=#__codelineno-25-87 id=__codelineno-25-87 name=__codelineno-25-87></a>    <span class=n>acc</span> <span class=o>=</span> <span class=n>evaluate_model</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>X_test</span><span class=p>,</span> <span class=n>y_test</span><span class=p>)</span>
</span><span id=__span-25-88><a href=#__codelineno-25-88 id=__codelineno-25-88 name=__codelineno-25-88></a>    <span class=nb>print</span><span class=p>(</span><span class=s1>'Accuracy: '</span><span class=p>,</span> <span class=n>acc</span><span class=p>)</span>
</span><span id=__span-25-89><a href=#__codelineno-25-89 id=__codelineno-25-89 name=__codelineno-25-89></a>    <span class=n>torch</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>model</span><span class=o>.</span><span class=n>state_dict</span><span class=p>(),</span> <span class=sa>f</span><span class=s1>'model_</span><span class=si>{</span><span class=n>epochs</span><span class=si>}</span><span class=s1>.pt'</span><span class=p>)</span>
</span></code></pre></div> <p>这个代码使用了PyTorch的<code>nn.Module</code>类来定义MLP模型，并使用了<code>optim.Adam</code>优化器和<code>nn.CrossEntropyLoss</code>损失函数。训练数据被封装在一个<code>DataLoader</code>对象中，该对象在每个epoch中迭代数据并更新模型的权重。最后，模型的权重被保存为一个<code>.pt</code>文件。</p> <p> </p> <p>SeazSu:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-26-1><a href=#__codelineno-26-1 id=__codelineno-26-1 name=__codelineno-26-1></a>Traceback<span class=w> </span><span class=o>(</span>most<span class=w> </span>recent<span class=w> </span>call<span class=w> </span>last<span class=o>)</span>:
</span><span id=__span-26-2><a href=#__codelineno-26-2 id=__codelineno-26-2 name=__codelineno-26-2></a><span class=w>  </span>File<span class=w> </span><span class=s2>"c:\PycharmProjects\NPUCM24\train_data_torch.py"</span>,<span class=w> </span>line<span class=w> </span><span class=m>112</span>,<span class=w> </span><span class=k>in</span><span class=w> </span>&lt;module>
</span><span id=__span-26-3><a href=#__codelineno-26-3 id=__codelineno-26-3 name=__codelineno-26-3></a><span class=w>    </span>X_train,<span class=w> </span>X_test,<span class=w> </span>y_train,<span class=w> </span><span class=nv>y_test</span><span class=w> </span><span class=o>=</span><span class=w> </span>preprocess<span class=o>(</span>data<span class=o>)</span>
</span><span id=__span-26-4><a href=#__codelineno-26-4 id=__codelineno-26-4 name=__codelineno-26-4></a><span class=w>  </span>File<span class=w> </span><span class=s2>"c:\PycharmProjects\NPUCM24\train_data_torch.py"</span>,<span class=w> </span>line<span class=w> </span><span class=m>46</span>,<span class=w> </span><span class=k>in</span><span class=w> </span>preprocess
</span><span id=__span-26-5><a href=#__codelineno-26-5 id=__codelineno-26-5 name=__codelineno-26-5></a><span class=w>    </span><span class=nv>y_train</span><span class=w> </span><span class=o>=</span><span class=w> </span>torch.from_numpy<span class=o>(</span>y_train<span class=o>)</span>
</span><span id=__span-26-6><a href=#__codelineno-26-6 id=__codelineno-26-6 name=__codelineno-26-6></a>TypeError:<span class=w> </span>can<span class=err>'</span>t<span class=w> </span>convert<span class=w> </span>np.ndarray<span class=w> </span>of<span class=w> </span><span class=nb>type</span><span class=w> </span>numpy.object_.<span class=w> </span>The<span class=w> </span>only<span class=w> </span>supported<span class=w> </span>types<span class=w> </span>are:<span class=w> </span>float64,<span class=w> </span>float32,<span class=w> </span>float16,<span class=w> </span>complex64,<span class=w> </span>complex128,<span class=w> </span>int64,<span class=w> </span>int32,<span class=w> </span>int16,<span class=w> </span>int8,<span class=w> </span>uint8,<span class=w> </span>and<span class=w> </span>bool.
</span></code></pre></div> <p>这个报错要如何解决？</p> <p> </p> <p>GitHub Copilot:</p> <p>这个错误是因为你试图将一个类型为<code>numpy.object_</code>的NumPy数组转换为PyTorch张量。PyTorch只支持将特定类型的NumPy数组转换为张量，包括<code>float64</code>、<code>float32</code>、<code>float16</code>、<code>complex64</code>、<code>complex128</code>、<code>int64</code>、<code>int32</code>、<code>int16</code>、<code>int8</code>、<code>uint8</code>和<code>bool</code>。</p> <p>你需要确保<code>y_train</code>是这些类型之一。如果<code>y_train</code>是类别标签，你可能需要将其转换为整数类型。你可以使用NumPy的<code>astype</code>函数来实现这一点：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-27-1><a href=#__codelineno-27-1 id=__codelineno-27-1 name=__codelineno-27-1></a><span class=c1># 数据预处理</span>
</span><span id=__span-27-2><a href=#__codelineno-27-2 id=__codelineno-27-2 name=__codelineno-27-2></a><span class=k>def</span><span class=w> </span><span class=nf>preprocess</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
</span><span id=__span-27-3><a href=#__codelineno-27-3 id=__codelineno-27-3 name=__codelineno-27-3></a>    <span class=c1># ... 代码保持不变 ...</span>
</span><span id=__span-27-4><a href=#__codelineno-27-4 id=__codelineno-27-4 name=__codelineno-27-4></a>
</span><span id=__span-27-5><a href=#__codelineno-27-5 id=__codelineno-27-5 name=__codelineno-27-5></a>    <span class=c1># 将数据转换为PyTorch张量</span>
</span><span id=__span-27-6><a href=#__codelineno-27-6 id=__codelineno-27-6 name=__codelineno-27-6></a>    <span class=n>X_train</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>from_numpy</span><span class=p>(</span><span class=n>X_train</span><span class=p>)</span>
</span><span id=__span-27-7><a href=#__codelineno-27-7 id=__codelineno-27-7 name=__codelineno-27-7></a>    <span class=n>X_test</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>from_numpy</span><span class=p>(</span><span class=n>X_test</span><span class=p>)</span>
</span><span id=__span-27-8><a href=#__codelineno-27-8 id=__codelineno-27-8 name=__codelineno-27-8></a>    <span class=n>y_train</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>from_numpy</span><span class=p>(</span><span class=n>y_train</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>))</span>  <span class=c1># 将y_train转换为int64类型</span>
</span><span id=__span-27-9><a href=#__codelineno-27-9 id=__codelineno-27-9 name=__codelineno-27-9></a>    <span class=n>y_test</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>from_numpy</span><span class=p>(</span><span class=n>y_test</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>))</span>  <span class=c1># 将y_test转换为int64类型</span>
</span><span id=__span-27-10><a href=#__codelineno-27-10 id=__codelineno-27-10 name=__codelineno-27-10></a>
</span><span id=__span-27-11><a href=#__codelineno-27-11 id=__codelineno-27-11 name=__codelineno-27-11></a>    <span class=k>return</span> <span class=n>X_train</span><span class=p>,</span> <span class=n>X_test</span><span class=p>,</span> <span class=n>y_train</span><span class=p>,</span> <span class=n>y_test</span>
</span></code></pre></div> <p>这个修改将<code>y_train</code>和<code>y_test</code>转换为<code>int64</code>类型，然后再将它们转换为PyTorch张量。这样，你就可以避免上述错误了。</p> <p> </p> <p>SeazSu:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-28-1><a href=#__codelineno-28-1 id=__codelineno-28-1 name=__codelineno-28-1></a>Traceback<span class=w> </span><span class=o>(</span>most<span class=w> </span>recent<span class=w> </span>call<span class=w> </span>last<span class=o>)</span>:
</span><span id=__span-28-2><a href=#__codelineno-28-2 id=__codelineno-28-2 name=__codelineno-28-2></a><span class=w>  </span>File<span class=w> </span><span class=s2>"c:\PycharmProjects\NPUCM24\train_data_torch.py"</span>,<span class=w> </span>line<span class=w> </span><span class=m>114</span>,<span class=w> </span><span class=k>in</span><span class=w> </span>&lt;module>
</span><span id=__span-28-3><a href=#__codelineno-28-3 id=__codelineno-28-3 name=__codelineno-28-3></a><span class=w>    </span><span class=nv>model</span><span class=w> </span><span class=o>=</span><span class=w> </span>train_model<span class=o>(</span>X_train,<span class=w> </span>y_train,<span class=w> </span>epochs<span class=o>)</span>
</span><span id=__span-28-4><a href=#__codelineno-28-4 id=__codelineno-28-4 name=__codelineno-28-4></a><span class=w>  </span>File<span class=w> </span><span class=s2>"c:\PycharmProjects\NPUCM24\train_data_torch.py"</span>,<span class=w> </span>line<span class=w> </span><span class=m>81</span>,<span class=w> </span><span class=k>in</span><span class=w> </span>train_model
</span><span id=__span-28-5><a href=#__codelineno-28-5 id=__codelineno-28-5 name=__codelineno-28-5></a><span class=w>    </span><span class=nv>outputs</span><span class=w> </span><span class=o>=</span><span class=w> </span>model<span class=o>(</span>inputs<span class=o>)</span>
</span><span id=__span-28-6><a href=#__codelineno-28-6 id=__codelineno-28-6 name=__codelineno-28-6></a><span class=w>  </span>...
</span><span id=__span-28-7><a href=#__codelineno-28-7 id=__codelineno-28-7 name=__codelineno-28-7></a>RuntimeError:<span class=w> </span>mat1<span class=w> </span>and<span class=w> </span>mat2<span class=w> </span>must<span class=w> </span>have<span class=w> </span>the<span class=w> </span>same<span class=w> </span>dtype,<span class=w> </span>but<span class=w> </span>got<span class=w> </span>Double<span class=w> </span>and<span class=w> </span>Float
</span></code></pre></div> <p>这个报错如何解决？</p> <p> </p> <p>GitHub Copilot:</p> <p>这个错误是因为你试图将两个不同数据类型的张量进行矩阵乘法。在你的情况下，一个张量的类型是Double，另一个张量的类型是Float。PyTorch要求这两个张量必须有相同的数据类型。</p> <p>你可以通过将输入数据转换为Float类型来解决这个问题。你可以在创建张量时使用<code>.float()</code>方法来实现这一点：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-29-1><a href=#__codelineno-29-1 id=__codelineno-29-1 name=__codelineno-29-1></a><span class=c1># 数据预处理</span>
</span><span id=__span-29-2><a href=#__codelineno-29-2 id=__codelineno-29-2 name=__codelineno-29-2></a><span class=k>def</span><span class=w> </span><span class=nf>preprocess</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
</span><span id=__span-29-3><a href=#__codelineno-29-3 id=__codelineno-29-3 name=__codelineno-29-3></a>    <span class=c1># ... 代码保持不变 ...</span>
</span><span id=__span-29-4><a href=#__codelineno-29-4 id=__codelineno-29-4 name=__codelineno-29-4></a>
</span><span id=__span-29-5><a href=#__codelineno-29-5 id=__codelineno-29-5 name=__codelineno-29-5></a>    <span class=c1># 将数据转换为PyTorch张量</span>
</span><span id=__span-29-6><a href=#__codelineno-29-6 id=__codelineno-29-6 name=__codelineno-29-6></a>    <span class=n>X_train</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>from_numpy</span><span class=p>(</span><span class=n>X_train</span><span class=p>)</span><span class=o>.</span><span class=n>float</span><span class=p>()</span>  <span class=c1># 将X_train转换为Float类型</span>
</span><span id=__span-29-7><a href=#__codelineno-29-7 id=__codelineno-29-7 name=__codelineno-29-7></a>    <span class=n>X_test</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>from_numpy</span><span class=p>(</span><span class=n>X_test</span><span class=p>)</span><span class=o>.</span><span class=n>float</span><span class=p>()</span>  <span class=c1># 将X_test转换为Float类型</span>
</span><span id=__span-29-8><a href=#__codelineno-29-8 id=__codelineno-29-8 name=__codelineno-29-8></a>    <span class=n>y_train</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>from_numpy</span><span class=p>(</span><span class=n>y_train</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>))</span>  <span class=c1># 将y_train转换为int64类型</span>
</span><span id=__span-29-9><a href=#__codelineno-29-9 id=__codelineno-29-9 name=__codelineno-29-9></a>    <span class=n>y_test</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>from_numpy</span><span class=p>(</span><span class=n>y_test</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>))</span>  <span class=c1># 将y_test转换为int64类型</span>
</span><span id=__span-29-10><a href=#__codelineno-29-10 id=__codelineno-29-10 name=__codelineno-29-10></a>
</span><span id=__span-29-11><a href=#__codelineno-29-11 id=__codelineno-29-11 name=__codelineno-29-11></a>    <span class=k>return</span> <span class=n>X_train</span><span class=p>,</span> <span class=n>X_test</span><span class=p>,</span> <span class=n>y_train</span><span class=p>,</span> <span class=n>y_test</span>
</span></code></pre></div> <p>这个修改将<code>X_train</code>和<code>X_test</code>转换为Float类型，然后再将它们转换为PyTorch张量。这样，你就可以避免上述错误了。</p></details><p>然后运行，发现就可以进行训练了(只是训练的时候没有显示)，<p>于是(得到权重后)开始编写shap相关的代码，大部分都和 <code>shap_tf.py</code> 一样<div class="language-python highlight"><table class=highlighttable><tr><th class=filename colspan=2><span class=filename>shap_torch.py</span><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-30-1> 1</a></span>
<span class=normal><a href=#__codelineno-30-2> 2</a></span>
<span class=normal><a href=#__codelineno-30-3> 3</a></span>
<span class=normal><a href=#__codelineno-30-4> 4</a></span>
<span class=normal><a href=#__codelineno-30-5> 5</a></span>
<span class=normal><a href=#__codelineno-30-6> 6</a></span>
<span class=normal><a href=#__codelineno-30-7> 7</a></span>
<span class=normal><a href=#__codelineno-30-8> 8</a></span>
<span class=normal><a href=#__codelineno-30-9> 9</a></span>
<span class=normal><a href=#__codelineno-30-10>10</a></span>
<span class=normal><a href=#__codelineno-30-11>11</a></span>
<span class=normal><a href=#__codelineno-30-12>12</a></span>
<span class=normal><a href=#__codelineno-30-13>13</a></span>
<span class=normal><a href=#__codelineno-30-14>14</a></span>
<span class=normal><a href=#__codelineno-30-15>15</a></span>
<span class=normal><a href=#__codelineno-30-16>16</a></span>
<span class=normal><a href=#__codelineno-30-17>17</a></span>
<span class=normal><a href=#__codelineno-30-18>18</a></span>
<span class=normal><a href=#__codelineno-30-19>19</a></span>
<span class=normal><a href=#__codelineno-30-20>20</a></span>
<span class=normal><a href=#__codelineno-30-21>21</a></span>
<span class=normal><a href=#__codelineno-30-22>22</a></span>
<span class=normal><a href=#__codelineno-30-23>23</a></span>
<span class=normal><a href=#__codelineno-30-24>24</a></span>
<span class=normal><a href=#__codelineno-30-25>25</a></span></pre></div><td class=code><div><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1></a><span class=kn>import</span><span class=w> </span><span class=nn>shap</span>
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2></a><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
</span><span id=__span-30-3><a id=__codelineno-30-3 name=__codelineno-30-3></a><span class=hll><span class=kn>import</span><span class=w> </span><span class=nn>torch</span>
</span></span><span id=__span-30-4><a id=__codelineno-30-4 name=__codelineno-30-4></a><span class=kn>from</span><span class=w> </span><span class=nn>train_data_torch</span><span class=w> </span><span class=kn>import</span> <span class=n>preprocess</span><span class=p>,</span> <span class=n>MLP</span>
</span><span id=__span-30-5><a id=__codelineno-30-5 name=__codelineno-30-5></a>
</span><span id=__span-30-6><a id=__codelineno-30-6 name=__codelineno-30-6></a><span class=c1># read and preprocess data</span>
</span><span id=__span-30-7><a id=__codelineno-30-7 name=__codelineno-30-7></a><span class=n>data</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s1>'merged_data.npy'</span><span class=p>,</span> <span class=n>allow_pickle</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-30-8><a id=__codelineno-30-8 name=__codelineno-30-8></a><span class=n>X_train</span><span class=p>,</span> <span class=n>X_test</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>preprocess</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-30-9><a id=__codelineno-30-9 name=__codelineno-30-9></a>
</span><span id=__span-30-10><a id=__codelineno-30-10 name=__codelineno-30-10></a><span class=c1># select a set of background examples to take an expectation over</span>
</span><span id=__span-30-11><a id=__codelineno-30-11 name=__codelineno-30-11></a><span class=n>background</span> <span class=o>=</span> <span class=n>X_train</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>X_train</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>100</span><span class=p>,</span> <span class=n>replace</span><span class=o>=</span><span class=kc>False</span><span class=p>)]</span>
</span><span id=__span-30-12><a id=__codelineno-30-12 name=__codelineno-30-12></a>
</span><span id=__span-30-13><a id=__codelineno-30-13 name=__codelineno-30-13></a><span class=c1># build model</span>
</span><span id=__span-30-14><a id=__codelineno-30-14 name=__codelineno-30-14></a><span class=hll><span class=n>model</span> <span class=o>=</span> <span class=n>MLP</span><span class=p>(</span><span class=n>X_train</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span id=__span-30-15><a id=__codelineno-30-15 name=__codelineno-30-15></a><span class=hll><span class=n>model</span><span class=o>.</span><span class=n>load_state_dict</span><span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s1>'model_200.pt'</span><span class=p>))</span>
</span></span><span id=__span-30-16><a id=__codelineno-30-16 name=__codelineno-30-16></a>
</span><span id=__span-30-17><a id=__codelineno-30-17 name=__codelineno-30-17></a><span class=c1># Assuming 'model' is your deep learning model and 'background' is a sample of your input data</span>
</span><span id=__span-30-18><a id=__codelineno-30-18 name=__codelineno-30-18></a><span class=n>explainer</span> <span class=o>=</span> <span class=n>shap</span><span class=o>.</span><span class=n>DeepExplainer</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>background</span><span class=p>)</span>
</span><span id=__span-30-19><a id=__codelineno-30-19 name=__codelineno-30-19></a>
</span><span id=__span-30-20><a id=__codelineno-30-20 name=__codelineno-30-20></a><span class=c1># 'test_data' is the data you want to explain</span>
</span><span id=__span-30-21><a id=__codelineno-30-21 name=__codelineno-30-21></a><span class=n>shap_values</span> <span class=o>=</span> <span class=n>explainer</span><span class=o>.</span><span class=n>shap_values</span><span class=p>(</span><span class=n>X_test</span><span class=p>[</span><span class=mi>1</span><span class=p>:</span><span class=mi>30</span><span class=p>])</span>
</span><span id=__span-30-22><a id=__codelineno-30-22 name=__codelineno-30-22></a>
</span><span id=__span-30-23><a id=__codelineno-30-23 name=__codelineno-30-23></a><span class=c1># plot the feature attributions</span>
</span><span id=__span-30-24><a id=__codelineno-30-24 name=__codelineno-30-24></a><span class=n>shap</span><span class=o>.</span><span class=n>image_plot</span><span class=p>(</span><span class=n>shap_values</span><span class=p>,</span> <span class=o>-</span><span class=n>X_test</span><span class=p>[</span><span class=mi>1</span><span class=p>:</span><span class=mi>30</span><span class=p>])</span>
</span><span id=__span-30-25><a id=__codelineno-30-25 name=__codelineno-30-25></a><span class=n>shap</span><span class=o>.</span><span class=n>summary_plot</span><span class=p>(</span><span class=n>shap_values</span><span class=p>)</span>
</span></code></pre></div></table></div><p>进行运行，出现报错<div class="language-bash highlight"><pre><span></span><code><span id=__span-31-1><a href=#__codelineno-31-1 id=__codelineno-31-1 name=__codelineno-31-1></a>Traceback<span class=w> </span><span class=o>(</span>most<span class=w> </span>recent<span class=w> </span>call<span class=w> </span>last<span class=o>)</span>:
</span><span id=__span-31-2><a href=#__codelineno-31-2 id=__codelineno-31-2 name=__codelineno-31-2></a><span class=w>  </span>File<span class=w> </span><span class=s2>"c:\PycharmProjects\NPUCM24\test3.py"</span>,<span class=w> </span>line<span class=w> </span><span class=m>28</span>,<span class=w> </span><span class=k>in</span><span class=w> </span>&lt;module>
</span><span id=__span-31-3><a href=#__codelineno-31-3 id=__codelineno-31-3 name=__codelineno-31-3></a><span class=w>    </span>shap.image_plot<span class=o>(</span>shap_values,<span class=w> </span>X_test<span class=o>)</span>
</span><span id=__span-31-4><a href=#__codelineno-31-4 id=__codelineno-31-4 name=__codelineno-31-4></a><span class=w>  </span>File<span class=w> </span><span class=s2>"C:\Users\Ronald\AppData\Local\Programs\Python\Python310\lib\site-packages\shap\plots\_image.py"</span>,<span class=w> </span>line<span class=w> </span><span class=m>121</span>,<span class=w> </span><span class=k>in</span><span class=w> </span>image
</span><span id=__span-31-5><a href=#__codelineno-31-5 id=__codelineno-31-5 name=__codelineno-31-5></a><span class=w>    </span><span class=nv>x_curr</span><span class=w> </span><span class=o>=</span><span class=w> </span>x<span class=o>[</span>row<span class=o>]</span>.copy<span class=o>()</span>
</span><span id=__span-31-6><a href=#__codelineno-31-6 id=__codelineno-31-6 name=__codelineno-31-6></a>AttributeError:<span class=w> </span><span class=s1>'Tensor'</span><span class=w> </span>object<span class=w> </span>has<span class=w> </span>no<span class=w> </span>attribute<span class=w> </span><span class=s1>'copy'</span>.<span class=w> </span>Did<span class=w> </span>you<span class=w> </span>mean:<span class=w> </span><span class=s1>'copy_'</span>?
</span></code></pre></div><p>进行询问<details class=example open><summary>对话记录</summary> <p>RonaldLN:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-32-1><a href=#__codelineno-32-1 id=__codelineno-32-1 name=__codelineno-32-1></a><span class=w>  </span>...
</span><span id=__span-32-2><a href=#__codelineno-32-2 id=__codelineno-32-2 name=__codelineno-32-2></a>AttributeError:<span class=w> </span><span class=s1>'Tensor'</span><span class=w> </span>object<span class=w> </span>has<span class=w> </span>no<span class=w> </span>attribute<span class=w> </span><span class=s1>'copy'</span>.<span class=w> </span>Did<span class=w> </span>you<span class=w> </span>mean:<span class=w> </span><span class=s1>'copy_'</span>?
</span></code></pre></div> <p> </p> <p>Github Copilot:</p> <p>这个错误是因为你试图在PyTorch张量上调用<code>copy</code>方法，但是PyTorch张量没有这个方法。你应该使用<code>clone</code>方法来复制PyTorch张量。</p> <p>然而，<code>shap.image_plot</code>函数需要的是NumPy数组，而不是PyTorch张量。因此，你需要将PyTorch张量转换回NumPy数组。你可以使用<code>.numpy()</code>方法来实现这一点：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-33-1><a href=#__codelineno-33-1 id=__codelineno-33-1 name=__codelineno-33-1></a><span class=c1># plot the feature attributions</span>
</span><span id=__span-33-2><a href=#__codelineno-33-2 id=__codelineno-33-2 name=__codelineno-33-2></a><span class=n>shap</span><span class=o>.</span><span class=n>image_plot</span><span class=p>(</span><span class=n>shap_values</span><span class=p>,</span> <span class=o>-</span><span class=n>X_test</span><span class=o>.</span><span class=n>numpy</span><span class=p>())</span>
</span></code></pre></div> <p>这个修改将<code>X_test</code>张量转换回NumPy数组，然后再传递给<code>shap.image_plot</code>函数。这样，你就可以避免上述错误了。</p></details><p>感觉又是包的代码的问题，于是继续去修改<div class="language-python highlight"><table class=highlighttable><tr><th class=filename colspan=2><span class=filename>.../plots/_image.py</span><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-34-121>121</a></span>
<span class=normal><a href=#__codelineno-34-122>122</a></span></pre></div><td class=code><div><pre><span></span><code><span id=__span-34-121><a id=__codelineno-34-121 name=__codelineno-34-121></a><span class=c1># x_curr = x[row].copy()</span>
</span><span id=__span-34-122><a id=__codelineno-34-122 name=__codelineno-34-122></a><span class=hll><span class=n>x_curr</span> <span class=o>=</span> <span class=n>x</span><span class=p>[</span><span class=n>row</span><span class=p>]</span><span class=o>.</span><span class=n>clone</span><span class=p>()</span>
</span></span></code></pre></div></table></div><p>再次运行就可以显示图像了<p><a class=glightbox data-desc-position=bottom data-height=auto data-type=image data-width=auto href=../../../../images/shap_summary_plot.svg><img alt=shap_summary_plot loading=lazy src=../../../../images/shap_summary_plot.svg></a><h2 id=xgboostshap>使用XGBoost模型进行训练，并计算SHAP值<a title="Permanent link" class=headerlink href=#xgboostshap>¶</a></h2><p>由于使用tensorflow训练的模型尝试了很久都无法成功计算shap值(一直有奇怪的报错)，而用pytorch训练的模型能成功计算shap值但似乎显示的图像也不明所以，<p>而<a href=https://shap.readthedocs.io/en/latest/api_examples.html>官方说明文档中的例子</a>中，只有使用XGBoost来训练并计算shap值的例子，<p>于是打算，先看看官方的例子能不能跑，如果能跑，再把输入训练的数据改成之前处理好的数据(这样应该就不会遇到太多报错)，<p>于是参考 <a href=https://shap.readthedocs.io/en/latest/example_notebooks/api_examples/explainers/Permutation.html><code>Permutation explainer</code></a> 中的例子<details class=note><summary>示例代码</summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-35-1> 1</a></span>
<span class=normal><a href=#__codelineno-35-2> 2</a></span>
<span class=normal><a href=#__codelineno-35-3> 3</a></span>
<span class=normal><a href=#__codelineno-35-4> 4</a></span>
<span class=normal><a href=#__codelineno-35-5> 5</a></span>
<span class=normal><a href=#__codelineno-35-6> 6</a></span>
<span class=normal><a href=#__codelineno-35-7> 7</a></span>
<span class=normal><a href=#__codelineno-35-8> 8</a></span>
<span class=normal><a href=#__codelineno-35-9> 9</a></span>
<span class=normal><a href=#__codelineno-35-10>10</a></span>
<span class=normal><a href=#__codelineno-35-11>11</a></span>
<span class=normal><a href=#__codelineno-35-12>12</a></span>
<span class=normal><a href=#__codelineno-35-13>13</a></span>
<span class=normal><a href=#__codelineno-35-14>14</a></span>
<span class=normal><a href=#__codelineno-35-15>15</a></span>
<span class=normal><a href=#__codelineno-35-16>16</a></span>
<span class=normal><a href=#__codelineno-35-17>17</a></span>
<span class=normal><a href=#__codelineno-35-18>18</a></span>
<span class=normal><a href=#__codelineno-35-19>19</a></span>
<span class=normal><a href=#__codelineno-35-20>20</a></span>
<span class=normal><a href=#__codelineno-35-21>21</a></span>
<span class=normal><a href=#__codelineno-35-22>22</a></span>
<span class=normal><a href=#__codelineno-35-23>23</a></span></pre></div><td class=code><div><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1></a><span class=kn>import</span><span class=w> </span><span class=nn>xgboost</span>
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2></a>
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3></a><span class=kn>import</span><span class=w> </span><span class=nn>shap</span>
</span><span id=__span-35-4><a id=__codelineno-35-4 name=__codelineno-35-4></a>
</span><span id=__span-35-5><a id=__codelineno-35-5 name=__codelineno-35-5></a><span class=c1># get a dataset on income prediction</span>
</span><span id=__span-35-6><a id=__codelineno-35-6 name=__codelineno-35-6></a><span class=n>X</span><span class=p>,</span> <span class=n>y</span> <span class=o>=</span> <span class=n>shap</span><span class=o>.</span><span class=n>datasets</span><span class=o>.</span><span class=n>adult</span><span class=p>()</span>
</span><span id=__span-35-7><a id=__codelineno-35-7 name=__codelineno-35-7></a>
</span><span id=__span-35-8><a id=__codelineno-35-8 name=__codelineno-35-8></a><span class=c1># train an XGBoost model (but any other model type would also work)</span>
</span><span id=__span-35-9><a id=__codelineno-35-9 name=__codelineno-35-9></a><span class=n>model</span> <span class=o>=</span> <span class=n>xgboost</span><span class=o>.</span><span class=n>XGBClassifier</span><span class=p>()</span>
</span><span id=__span-35-10><a id=__codelineno-35-10 name=__codelineno-35-10></a><span class=n>model</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span><span id=__span-35-11><a id=__codelineno-35-11 name=__codelineno-35-11></a>
</span><span id=__span-35-12><a id=__codelineno-35-12 name=__codelineno-35-12></a><span class=c1># build a Permutation explainer and explain the model predictions on the given dataset</span>
</span><span id=__span-35-13><a id=__codelineno-35-13 name=__codelineno-35-13></a><span class=n>explainer</span> <span class=o>=</span> <span class=n>shap</span><span class=o>.</span><span class=n>explainers</span><span class=o>.</span><span class=n>Permutation</span><span class=p>(</span><span class=n>model</span><span class=o>.</span><span class=n>predict_proba</span><span class=p>,</span> <span class=n>X</span><span class=p>)</span>
</span><span id=__span-35-14><a id=__codelineno-35-14 name=__codelineno-35-14></a><span class=n>shap_values</span> <span class=o>=</span> <span class=n>explainer</span><span class=p>(</span><span class=n>X</span><span class=p>[:</span><span class=mi>100</span><span class=p>])</span>
</span><span id=__span-35-15><a id=__codelineno-35-15 name=__codelineno-35-15></a>
</span><span id=__span-35-16><a id=__codelineno-35-16 name=__codelineno-35-16></a><span class=c1># get just the explanations for the positive class</span>
</span><span id=__span-35-17><a id=__codelineno-35-17 name=__codelineno-35-17></a><span class=n>shap_values</span> <span class=o>=</span> <span class=n>shap_values</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
</span><span id=__span-35-18><a id=__codelineno-35-18 name=__codelineno-35-18></a>
</span><span id=__span-35-19><a id=__codelineno-35-19 name=__codelineno-35-19></a><span class=c1># Plot a global summary</span>
</span><span id=__span-35-20><a id=__codelineno-35-20 name=__codelineno-35-20></a><span class=n>shap</span><span class=o>.</span><span class=n>plots</span><span class=o>.</span><span class=n>bar</span><span class=p>(</span><span class=n>shap_values</span><span class=p>)</span>
</span><span id=__span-35-21><a id=__codelineno-35-21 name=__codelineno-35-21></a>
</span><span id=__span-35-22><a id=__codelineno-35-22 name=__codelineno-35-22></a><span class=c1># Plot a single instance</span>
</span><span id=__span-35-23><a id=__codelineno-35-23 name=__codelineno-35-23></a><span class=n>shap</span><span class=o>.</span><span class=n>plots</span><span class=o>.</span><span class=n>waterfall</span><span class=p>(</span><span class=n>shap_values</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></code></pre></div></table></div></details><p>能正常运行，然后查看输入数据的格式<blockquote><div class="language-python highlight"><pre><span></span><code><span id=__span-36-1><a href=#__codelineno-36-1 id=__codelineno-36-1 name=__codelineno-36-1></a><span class=nb>print</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=s2>"</span><span class=se>\n</span><span class=s2>"</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span><span id=__span-36-2><a href=#__codelineno-36-2 id=__codelineno-36-2 name=__codelineno-36-2></a><span class=nb>print</span><span class=p>(</span><span class=n>X</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=s2>"</span><span class=se>\n</span><span class=s2>"</span><span class=p>,</span> <span class=n>y</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span><span id=__span-36-3><a href=#__codelineno-36-3 id=__codelineno-36-3 name=__codelineno-36-3></a><span class=nb>print</span><span class=p>(</span><span class=nb>type</span><span class=p>(</span><span class=n>X</span><span class=p>),</span> <span class=s2>"</span><span class=se>\n</span><span class=s2>"</span><span class=p>,</span> <span class=nb>type</span><span class=p>(</span><span class=n>y</span><span class=p>))</span>
</span></code></pre></div></blockquote><div class="language-bash highlight"><pre><span></span><code><span id=__span-37-1><a href=#__codelineno-37-1 id=__codelineno-37-1 name=__codelineno-37-1></a><span class=w>        </span>Age<span class=w>  </span>Workclass<span class=w>  </span>...<span class=w>  </span>Hours<span class=w> </span>per<span class=w> </span>week<span class=w>  </span>Country
</span><span id=__span-37-2><a href=#__codelineno-37-2 id=__codelineno-37-2 name=__codelineno-37-2></a><span class=m>0</span><span class=w>      </span><span class=m>39</span>.0<span class=w>          </span><span class=m>7</span><span class=w>  </span>...<span class=w>            </span><span class=m>40</span>.0<span class=w>       </span><span class=m>39</span>
</span><span id=__span-37-3><a href=#__codelineno-37-3 id=__codelineno-37-3 name=__codelineno-37-3></a><span class=m>1</span><span class=w>      </span><span class=m>50</span>.0<span class=w>          </span><span class=m>6</span><span class=w>  </span>...<span class=w>            </span><span class=m>13</span>.0<span class=w>       </span><span class=m>39</span>
</span><span id=__span-37-4><a href=#__codelineno-37-4 id=__codelineno-37-4 name=__codelineno-37-4></a><span class=m>2</span><span class=w>      </span><span class=m>38</span>.0<span class=w>          </span><span class=m>4</span><span class=w>  </span>...<span class=w>            </span><span class=m>40</span>.0<span class=w>       </span><span class=m>39</span>
</span><span id=__span-37-5><a href=#__codelineno-37-5 id=__codelineno-37-5 name=__codelineno-37-5></a><span class=m>3</span><span class=w>      </span><span class=m>53</span>.0<span class=w>          </span><span class=m>4</span><span class=w>  </span>...<span class=w>            </span><span class=m>40</span>.0<span class=w>       </span><span class=m>39</span>
</span><span id=__span-37-6><a href=#__codelineno-37-6 id=__codelineno-37-6 name=__codelineno-37-6></a><span class=m>4</span><span class=w>      </span><span class=m>28</span>.0<span class=w>          </span><span class=m>4</span><span class=w>  </span>...<span class=w>            </span><span class=m>40</span>.0<span class=w>        </span><span class=m>5</span>
</span><span id=__span-37-7><a href=#__codelineno-37-7 id=__codelineno-37-7 name=__codelineno-37-7></a>...<span class=w>     </span>...<span class=w>        </span>...<span class=w>  </span>...<span class=w>             </span>...<span class=w>      </span>...
</span><span id=__span-37-8><a href=#__codelineno-37-8 id=__codelineno-37-8 name=__codelineno-37-8></a><span class=m>32556</span><span class=w>  </span><span class=m>27</span>.0<span class=w>          </span><span class=m>4</span><span class=w>  </span>...<span class=w>            </span><span class=m>38</span>.0<span class=w>       </span><span class=m>39</span>
</span><span id=__span-37-9><a href=#__codelineno-37-9 id=__codelineno-37-9 name=__codelineno-37-9></a><span class=m>32557</span><span class=w>  </span><span class=m>40</span>.0<span class=w>          </span><span class=m>4</span><span class=w>  </span>...<span class=w>            </span><span class=m>40</span>.0<span class=w>       </span><span class=m>39</span>
</span><span id=__span-37-10><a href=#__codelineno-37-10 id=__codelineno-37-10 name=__codelineno-37-10></a><span class=m>32558</span><span class=w>  </span><span class=m>58</span>.0<span class=w>          </span><span class=m>4</span><span class=w>  </span>...<span class=w>            </span><span class=m>40</span>.0<span class=w>       </span><span class=m>39</span>
</span><span id=__span-37-11><a href=#__codelineno-37-11 id=__codelineno-37-11 name=__codelineno-37-11></a><span class=m>32559</span><span class=w>  </span><span class=m>22</span>.0<span class=w>          </span><span class=m>4</span><span class=w>  </span>...<span class=w>            </span><span class=m>20</span>.0<span class=w>       </span><span class=m>39</span>
</span><span id=__span-37-12><a href=#__codelineno-37-12 id=__codelineno-37-12 name=__codelineno-37-12></a><span class=m>32560</span><span class=w>  </span><span class=m>52</span>.0<span class=w>          </span><span class=m>5</span><span class=w>  </span>...<span class=w>            </span><span class=m>40</span>.0<span class=w>       </span><span class=m>39</span>
</span><span id=__span-37-13><a href=#__codelineno-37-13 id=__codelineno-37-13 name=__codelineno-37-13></a>
</span><span id=__span-37-14><a href=#__codelineno-37-14 id=__codelineno-37-14 name=__codelineno-37-14></a><span class=o>[</span><span class=m>32561</span><span class=w> </span>rows<span class=w> </span>x<span class=w> </span><span class=m>12</span><span class=w> </span>columns<span class=o>]</span>
</span><span id=__span-37-15><a href=#__codelineno-37-15 id=__codelineno-37-15 name=__codelineno-37-15></a><span class=w> </span><span class=o>[</span>False<span class=w> </span>False<span class=w> </span>False<span class=w> </span>...<span class=w> </span>False<span class=w> </span>False<span class=w>  </span>True<span class=o>]</span>
</span><span id=__span-37-16><a href=#__codelineno-37-16 id=__codelineno-37-16 name=__codelineno-37-16></a><span class=o>(</span><span class=m>32561</span>,<span class=w> </span><span class=m>12</span><span class=o>)</span>
</span><span id=__span-37-17><a href=#__codelineno-37-17 id=__codelineno-37-17 name=__codelineno-37-17></a><span class=w> </span><span class=o>(</span><span class=m>32561</span>,<span class=o>)</span>
</span><span id=__span-37-18><a href=#__codelineno-37-18 id=__codelineno-37-18 name=__codelineno-37-18></a>&lt;class<span class=w> </span><span class=s1>'pandas.core.frame.DataFrame'</span>>
</span><span id=__span-37-19><a href=#__codelineno-37-19 id=__codelineno-37-19 name=__codelineno-37-19></a><span class=w> </span>&lt;class<span class=w> </span><span class=s1>'numpy.ndarray'</span>>
</span></code></pre></div><p>尝试将 <code>X</code> 转换成numpy array数组再运行，发现也能运行，只是最后画图时，每个特征没有名字(显示的是 <code>Feature n</code> )，于是就开始使用之前处理的数据<div class="language-python highlight"><span class=filename>shap_xgboost.py</span><pre><span></span><code><span id=__span-38-1><a href=#__codelineno-38-1 id=__codelineno-38-1 name=__codelineno-38-1></a><span class=o>...</span>
</span><span id=__span-38-2><a href=#__codelineno-38-2 id=__codelineno-38-2 name=__codelineno-38-2></a><span class=kn>from</span><span class=w> </span><span class=nn>train_data</span><span class=w> </span><span class=kn>import</span> <span class=n>preprocess</span>
</span><span id=__span-38-3><a href=#__codelineno-38-3 id=__codelineno-38-3 name=__codelineno-38-3></a>
</span><span id=__span-38-4><a href=#__codelineno-38-4 id=__codelineno-38-4 name=__codelineno-38-4></a><span class=c1># get a dataset on income prediction</span>
</span><span id=__span-38-5><a href=#__codelineno-38-5 id=__codelineno-38-5 name=__codelineno-38-5></a><span class=c1># X, y = shap.datasets.adult()</span>
</span><span id=__span-38-6><a href=#__codelineno-38-6 id=__codelineno-38-6 name=__codelineno-38-6></a><span class=n>data</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s1>'merged_data.npy'</span><span class=p>,</span> <span class=n>allow_pickle</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-38-7><a href=#__codelineno-38-7 id=__codelineno-38-7 name=__codelineno-38-7></a><span class=n>X_train</span><span class=p>,</span> <span class=n>X_test</span><span class=p>,</span> <span class=n>y_train</span><span class=p>,</span> <span class=n>y_test</span> <span class=o>=</span> <span class=n>preprocess</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-38-8><a href=#__codelineno-38-8 id=__codelineno-38-8 name=__codelineno-38-8></a>
</span><span id=__span-38-9><a href=#__codelineno-38-9 id=__codelineno-38-9 name=__codelineno-38-9></a><span class=n>X</span> <span class=o>=</span> <span class=n>X_train</span>
</span><span id=__span-38-10><a href=#__codelineno-38-10 id=__codelineno-38-10 name=__codelineno-38-10></a><span class=n>y</span> <span class=o>=</span> <span class=n>y_train</span>
</span><span id=__span-38-11><a href=#__codelineno-38-11 id=__codelineno-38-11 name=__codelineno-38-11></a>
</span><span id=__span-38-12><a href=#__codelineno-38-12 id=__codelineno-38-12 name=__codelineno-38-12></a><span class=o>...</span>
</span></code></pre></div><p>出现报错<div class="language-bash highlight"><pre><span></span><code><span id=__span-39-1><a href=#__codelineno-39-1 id=__codelineno-39-1 name=__codelineno-39-1></a>ValueError:<span class=w> </span><span class=nv>max_evals</span><span class=o>=</span><span class=m>500</span><span class=w> </span>is<span class=w> </span>too<span class=w> </span>low<span class=w> </span><span class=k>for</span><span class=w> </span>the<span class=w> </span>Permutation<span class=w> </span>explainer,<span class=w> </span>it<span class=w> </span>must<span class=w> </span>be<span class=w> </span>at<span class=w> </span>least<span class=w> </span><span class=m>2</span><span class=w> </span>*<span class=w> </span>num_features<span class=w> </span>+<span class=w> </span><span class=nv>1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>26327</span>!
</span></code></pre></div><p>于是添加 <code>max_evals</code><div class="language-python highlight"><pre><span></span><code><span id=__span-40-1><a href=#__codelineno-40-1 id=__codelineno-40-1 name=__codelineno-40-1></a><span class=n>explainer</span> <span class=o>=</span> <span class=n>shap</span><span class=o>.</span><span class=n>explainers</span><span class=o>.</span><span class=n>Permutation</span><span class=p>(</span><span class=n>model</span><span class=o>.</span><span class=n>predict_proba</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>max_evals</span><span class=o>=</span><span class=mi>30000</span><span class=p>)</span>
</span></code></pre></div><p>继续运行，出现报错<div class="language-bash highlight"><pre><span></span><code><span id=__span-41-1><a href=#__codelineno-41-1 id=__codelineno-41-1 name=__codelineno-41-1></a>Traceback<span class=w> </span><span class=o>(</span>most<span class=w> </span>recent<span class=w> </span>call<span class=w> </span>last<span class=o>)</span>:
</span><span id=__span-41-2><a href=#__codelineno-41-2 id=__codelineno-41-2 name=__codelineno-41-2></a><span class=w>  </span>File<span class=w> </span><span class=s2>"c:\PycharmProjects\NPUCM24\shap_xgboost.py"</span>,<span class=w> </span>line<span class=w> </span><span class=m>28</span>,<span class=w> </span><span class=k>in</span><span class=w> </span>&lt;module>
</span><span id=__span-41-3><a href=#__codelineno-41-3 id=__codelineno-41-3 name=__codelineno-41-3></a><span class=w>    </span><span class=nv>shap_values</span><span class=w> </span><span class=o>=</span><span class=w> </span>explainer<span class=o>(</span>X<span class=o>[</span>:100<span class=o>])</span>
</span><span id=__span-41-4><a href=#__codelineno-41-4 id=__codelineno-41-4 name=__codelineno-41-4></a><span class=w>  </span>...
</span><span id=__span-41-5><a href=#__codelineno-41-5 id=__codelineno-41-5 name=__codelineno-41-5></a>numpy.core._exceptions._ArrayMemoryError:<span class=w> </span>Unable<span class=w> </span>to<span class=w> </span>allocate<span class=w> </span><span class=m>258</span>.<span class=w> </span>GiB<span class=w> </span><span class=k>for</span><span class=w> </span>an<span class=w> </span>array<span class=w> </span>with<span class=w> </span>shape<span class=w> </span><span class=o>(</span><span class=m>2632700</span>,<span class=w> </span><span class=m>13163</span><span class=o>)</span><span class=w> </span>and<span class=w> </span>data<span class=w> </span><span class=nb>type</span><span class=w> </span>float64<span class=w>  </span>
</span></code></pre></div><p>于是在计算SHAP值时，只取5个输入<div class="language-python highlight"><pre><span></span><code><span id=__span-42-1><a href=#__codelineno-42-1 id=__codelineno-42-1 name=__codelineno-42-1></a><span class=o>...</span>
</span><span id=__span-42-2><a href=#__codelineno-42-2 id=__codelineno-42-2 name=__codelineno-42-2></a><span class=hll><span class=n>X</span> <span class=o>=</span> <span class=n>X_train</span><span class=p>[:</span><span class=mi>5</span><span class=p>]</span>
</span></span><span id=__span-42-3><a href=#__codelineno-42-3 id=__codelineno-42-3 name=__codelineno-42-3></a><span class=hll><span class=n>y</span> <span class=o>=</span> <span class=n>y_train</span><span class=p>[:</span><span class=mi>5</span><span class=p>]</span>
</span></span><span id=__span-42-4><a href=#__codelineno-42-4 id=__codelineno-42-4 name=__codelineno-42-4></a>
</span><span id=__span-42-5><a href=#__codelineno-42-5 id=__codelineno-42-5 name=__codelineno-42-5></a><span class=c1># build a Permutation explainer and explain the model predictions on the given dataset</span>
</span><span id=__span-42-6><a href=#__codelineno-42-6 id=__codelineno-42-6 name=__codelineno-42-6></a><span class=n>explainer</span> <span class=o>=</span> <span class=n>shap</span><span class=o>.</span><span class=n>explainers</span><span class=o>.</span><span class=n>Permutation</span><span class=p>(</span><span class=n>model</span><span class=o>.</span><span class=n>predict_proba</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>max_evals</span><span class=o>=</span><span class=mi>30000</span><span class=p>)</span>
</span><span id=__span-42-7><a href=#__codelineno-42-7 id=__codelineno-42-7 name=__codelineno-42-7></a><span class=n>shap_values</span> <span class=o>=</span> <span class=n>explainer</span><span class=p>(</span><span class=n>X</span><span class=p>[:</span><span class=mi>100</span><span class=p>])</span>
</span><span id=__span-42-8><a href=#__codelineno-42-8 id=__codelineno-42-8 name=__codelineno-42-8></a>
</span><span id=__span-42-9><a href=#__codelineno-42-9 id=__codelineno-42-9 name=__codelineno-42-9></a><span class=o>...</span>
</span></code></pre></div><p>再次运行，就没有报错了，<p>运行了十几分钟之后，显示出了图像<div class="tabbed-set tabbed-alternate" data-tabs=1:2><input checked id=__tabbed_1_1 name=__tabbed_1 type=radio><input id=__tabbed_1_2 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1>bar</label><label for=__tabbed_1_2>waterfall</label></div><div class=tabbed-content><div class=tabbed-block><p><a class=glightbox data-desc-position=bottom data-height=auto data-type=image data-width=auto href=../../../../images/shap_bar.svg><img alt=shap_bar loading=lazy src=../../../../images/shap_bar.svg></a></div><div class=tabbed-block><p><a class=glightbox data-desc-position=bottom data-height=auto data-type=image data-width=auto href=../../../../images/shap_waterfall.svg><img alt=shap_waterfall loading=lazy src=../../../../images/shap_waterfall.svg></a></div></div></div><blockquote><p>可以通过 <code>max_display</code> 参数调整显示的特征个数<blockquote><p>通过在 <code>shap/plots/_bar.py</code> 中查看 <code>bar</code> 的定义</blockquote></blockquote><hr><p>打算修改XGBoost分类器的设置参数，于是前往官方文档查询API说明<p><a href=https://xgboost.readthedocs.io/en/stable/python/python_api.html#xgboost.XGBClassifier>Python API Reference — xgboost 2.0.3 documentation</a><p>由于不清楚参数都是什么意思，于是询问chatgpt<details class=example open><summary>对话记录</summary> <p>You:</p> <p>...(官方文档说明)</p> <p> </p> <p>ChatGPT:</p> <p>当你设置XGBoost分类器时，你可以调整许多参数来控制模型的行为。以下是其中一些主要参数的解释：</p> <ol><li><strong>n_estimators</strong>：Boosting轮数，即要构建的基本模型（树）的数量。<li><strong>max_depth</strong>：每棵树的最大深度。它控制树的复杂度，防止过拟合。<li><strong>learning_rate</strong>：学习率，也称为eta。它决定每棵树的贡献程度。较小的学习率需要更多的树来拟合数据，但通常会带来更好的泛化能力。<li><strong>verbosity</strong>：控制XGBoost输出的详细程度。0是最安静的，3是最详细的。<li><strong>objective</strong>：学习任务和相应的学习目标。对于分类任务，默认为'binary:logistic'，表示二分类问题的逻辑回归。<li><strong>booster</strong>：指定使用的增强器类型，可以是'gbtree'（基于树的增强）、'gblinear'（线性模型）或'dart'（Dropouts meet Multiple Additive Regression Trees）。<li><strong>gamma</strong>：叶节点分裂所需的最小损失减少量。它控制树的生长方式，防止过拟合。<li><strong>subsample</strong>：用于训练每棵树的样本子集的比例。它可以防止过拟合，提高模型的泛化能力。</ol> <p>这些是其中一些最重要的参数，根据你的具体问题，可能还有其他参数需要调整。</p> <p> </p> <p>You:</p> <p>在我要训练的数据中，每个输入有13000个特征，你说的这些参数怎么设置更合适？</p> <p> </p> <p>ChatGPT:</p> <p>对于具有13000个特征的数据集，你可能需要特别注意模型的复杂性和训练时间。以下是一些建议的参数设置：</p> <ol><li><strong>n_estimators</strong>：通常，你可能需要更多的树来拟合具有13000个特征的数据集。开始时可以尝试较小的值，比如100，然后根据模型的性能逐步增加。<li><strong>max_depth</strong>：由于特征数量较多，你可能需要限制树的深度以防止过拟合。尝试设置一个相对较小的值，比如5或者10。<li><strong>learning_rate</strong>：较小的学习率通常更适合具有大量特征的数据集。开始时可以尝试较小的值，比如0.1或者0.01。<li><strong>subsample</strong>：由于特征数量较多，可以考虑使用较小的样本子集来训练每棵树，以加快训练速度并提高模型的泛化能力。尝试设置一个较小的值，比如0.8。<li><strong>gamma</strong>：可以尝试设置一个较小的值，比如0.1，以控制树的生长方式并防止过拟合。<li><strong>max_bin</strong>：可以考虑增加每个特征的最大bin数以提高模型的拟合能力。<li><strong>colsample_bytree</strong>：考虑使用较小的特征子集来构建每棵树，以增加模型的多样性。尝试设置一个较小的值，比如0.8。<li><strong>objective</strong>：对于分类问题，默认的'binary:logistic'通常是一个不错的选择，但你也可以根据具体情况尝试其他目标函数。</ol> <p>请注意，以上建议是一些常见的经验法则，最终的参数设置应该根据你的数据集和具体问题进行调整和优化。你可能需要使用交叉验证等技术来选择最佳的参数组合。</p></details><p>于是参考chatgpt的回答重新进行训练，<div class="language-python highlight"><table class=highlighttable><tr><th class=filename colspan=2><span class=filename>train_data_xgboost.py</span><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-43-1> 1</a></span>
<span class=normal><a href=#__codelineno-43-2> 2</a></span>
<span class=normal><a href=#__codelineno-43-3> 3</a></span>
<span class=normal><a href=#__codelineno-43-4> 4</a></span>
<span class=normal><a href=#__codelineno-43-5> 5</a></span>
<span class=normal><a href=#__codelineno-43-6> 6</a></span>
<span class=normal><a href=#__codelineno-43-7> 7</a></span>
<span class=normal><a href=#__codelineno-43-8> 8</a></span>
<span class=normal><a href=#__codelineno-43-9> 9</a></span>
<span class=normal><a href=#__codelineno-43-10>10</a></span>
<span class=normal><a href=#__codelineno-43-11>11</a></span>
<span class=normal><a href=#__codelineno-43-12>12</a></span>
<span class=normal><a href=#__codelineno-43-13>13</a></span>
<span class=normal><a href=#__codelineno-43-14>14</a></span>
<span class=normal><a href=#__codelineno-43-15>15</a></span>
<span class=normal><a href=#__codelineno-43-16>16</a></span>
<span class=normal><a href=#__codelineno-43-17>17</a></span>
<span class=normal><a href=#__codelineno-43-18>18</a></span>
<span class=normal><a href=#__codelineno-43-19>19</a></span>
<span class=normal><a href=#__codelineno-43-20>20</a></span>
<span class=normal><a href=#__codelineno-43-21>21</a></span>
<span class=normal><a href=#__codelineno-43-22>22</a></span>
<span class=normal><a href=#__codelineno-43-23>23</a></span>
<span class=normal><a href=#__codelineno-43-24>24</a></span>
<span class=normal><a href=#__codelineno-43-25>25</a></span>
<span class=normal><a href=#__codelineno-43-26>26</a></span></pre></div><td class=code><div><pre><span></span><code><span id=__span-43-1><a id=__codelineno-43-1 name=__codelineno-43-1></a><span class=kn>import</span><span class=w> </span><span class=nn>xgboost</span>
</span><span id=__span-43-2><a id=__codelineno-43-2 name=__codelineno-43-2></a><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
</span><span id=__span-43-3><a id=__codelineno-43-3 name=__codelineno-43-3></a><span class=kn>from</span><span class=w> </span><span class=nn>sklearn.metrics</span><span class=w> </span><span class=kn>import</span> <span class=n>accuracy_score</span>
</span><span id=__span-43-4><a id=__codelineno-43-4 name=__codelineno-43-4></a><span class=kn>from</span><span class=w> </span><span class=nn>sklearn.metrics</span><span class=w> </span><span class=kn>import</span> <span class=n>classification_report</span>
</span><span id=__span-43-5><a id=__codelineno-43-5 name=__codelineno-43-5></a>
</span><span id=__span-43-6><a id=__codelineno-43-6 name=__codelineno-43-6></a><span class=kn>from</span><span class=w> </span><span class=nn>train_data</span><span class=w> </span><span class=kn>import</span> <span class=n>preprocess</span>
</span><span id=__span-43-7><a id=__codelineno-43-7 name=__codelineno-43-7></a>
</span><span id=__span-43-8><a id=__codelineno-43-8 name=__codelineno-43-8></a><span class=c1># get a dataset on income prediction</span>
</span><span id=__span-43-9><a id=__codelineno-43-9 name=__codelineno-43-9></a><span class=n>data</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s1>'merged_data.npy'</span><span class=p>,</span> <span class=n>allow_pickle</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-43-10><a id=__codelineno-43-10 name=__codelineno-43-10></a><span class=n>X_train</span><span class=p>,</span> <span class=n>X_test</span><span class=p>,</span> <span class=n>y_train</span><span class=p>,</span> <span class=n>y_test</span> <span class=o>=</span> <span class=n>preprocess</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-43-11><a id=__codelineno-43-11 name=__codelineno-43-11></a>
</span><span id=__span-43-12><a id=__codelineno-43-12 name=__codelineno-43-12></a><span class=n>X</span> <span class=o>=</span> <span class=n>X_train</span>
</span><span id=__span-43-13><a id=__codelineno-43-13 name=__codelineno-43-13></a><span class=n>y</span> <span class=o>=</span> <span class=n>y_train</span>
</span><span id=__span-43-14><a id=__codelineno-43-14 name=__codelineno-43-14></a>
</span><span id=__span-43-15><a id=__codelineno-43-15 name=__codelineno-43-15></a><span class=c1># train an XGBoost model (but any other model type would also work)</span>
</span><span id=__span-43-16><a id=__codelineno-43-16 name=__codelineno-43-16></a><span class=n>model</span> <span class=o>=</span> <span class=n>xgboost</span><span class=o>.</span><span class=n>XGBClassifier</span><span class=p>(</span><span class=n>n_estimators</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span> <span class=n>max_depth</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>learning_rate</span><span class=o>=</span><span class=mf>0.01</span><span class=p>,</span> <span class=n>subsample</span><span class=o>=</span><span class=mf>0.8</span><span class=p>,</span> <span class=n>colsample_bytree</span><span class=o>=</span><span class=mf>0.8</span><span class=p>)</span>
</span><span id=__span-43-17><a id=__codelineno-43-17 name=__codelineno-43-17></a><span class=n>model</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span><span id=__span-43-18><a id=__codelineno-43-18 name=__codelineno-43-18></a>
</span><span id=__span-43-19><a id=__codelineno-43-19 name=__codelineno-43-19></a><span class=n>preds</span> <span class=o>=</span>  <span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>X_test</span><span class=p>)</span>
</span><span id=__span-43-20><a id=__codelineno-43-20 name=__codelineno-43-20></a>
</span><span id=__span-43-21><a id=__codelineno-43-21 name=__codelineno-43-21></a><span class=nb>print</span><span class=p>(</span><span class=n>accuracy_score</span><span class=p>(</span><span class=n>y_test</span><span class=p>,</span> <span class=n>preds</span><span class=p>))</span>
</span><span id=__span-43-22><a id=__codelineno-43-22 name=__codelineno-43-22></a>
</span><span id=__span-43-23><a id=__codelineno-43-23 name=__codelineno-43-23></a><span class=n>cr</span> <span class=o>=</span> <span class=n>classification_report</span><span class=p>(</span><span class=n>y_test</span><span class=p>,</span> <span class=n>preds</span><span class=p>)</span>
</span><span id=__span-43-24><a id=__codelineno-43-24 name=__codelineno-43-24></a><span class=nb>print</span><span class=p>(</span><span class=n>cr</span><span class=p>)</span>
</span><span id=__span-43-25><a id=__codelineno-43-25 name=__codelineno-43-25></a>
</span><span id=__span-43-26><a id=__codelineno-43-26 name=__codelineno-43-26></a><span class=n>model</span><span class=o>.</span><span class=n>save_model</span><span class=p>(</span><span class=s2>"xgboost_model.json"</span><span class=p>)</span>
</span></code></pre></div></table></div><p>(没想到竟然跑了10几分钟)最后显示的预测效果(居然和神经网络的效果差不多，甚至还略好一些)<div class="language-bash highlight"><pre><span></span><code><span id=__span-44-1><a href=#__codelineno-44-1 id=__codelineno-44-1 name=__codelineno-44-1></a><span class=w>              </span>precision<span class=w>    </span>recall<span class=w>  </span>f1-score<span class=w>   </span>support
</span><span id=__span-44-2><a href=#__codelineno-44-2 id=__codelineno-44-2 name=__codelineno-44-2></a>
</span><span id=__span-44-3><a href=#__codelineno-44-3 id=__codelineno-44-3 name=__codelineno-44-3></a><span class=w>         </span><span class=m>0</span>.0<span class=w>       </span><span class=m>0</span>.96<span class=w>      </span><span class=m>1</span>.00<span class=w>      </span><span class=m>0</span>.98<span class=w>        </span><span class=m>23</span>
</span><span id=__span-44-4><a href=#__codelineno-44-4 id=__codelineno-44-4 name=__codelineno-44-4></a><span class=w>         </span><span class=m>1</span>.0<span class=w>       </span><span class=m>0</span>.57<span class=w>      </span><span class=m>0</span>.36<span class=w>      </span><span class=m>0</span>.44<span class=w>        </span><span class=m>22</span>
</span><span id=__span-44-5><a href=#__codelineno-44-5 id=__codelineno-44-5 name=__codelineno-44-5></a><span class=w>         </span><span class=m>2</span>.0<span class=w>       </span><span class=m>0</span>.69<span class=w>      </span><span class=m>0</span>.83<span class=w>      </span><span class=m>0</span>.75<span class=w>        </span><span class=m>35</span>
</span><span id=__span-44-6><a href=#__codelineno-44-6 id=__codelineno-44-6 name=__codelineno-44-6></a>
</span><span id=__span-44-7><a href=#__codelineno-44-7 id=__codelineno-44-7 name=__codelineno-44-7></a><span class=w>    </span>accuracy<span class=w>                           </span><span class=m>0</span>.75<span class=w>        </span><span class=m>80</span>
</span><span id=__span-44-8><a href=#__codelineno-44-8 id=__codelineno-44-8 name=__codelineno-44-8></a><span class=w>   </span>macro<span class=w> </span>avg<span class=w>       </span><span class=m>0</span>.74<span class=w>      </span><span class=m>0</span>.73<span class=w>      </span><span class=m>0</span>.73<span class=w>        </span><span class=m>80</span>
</span><span id=__span-44-9><a href=#__codelineno-44-9 id=__codelineno-44-9 name=__codelineno-44-9></a>weighted<span class=w> </span>avg<span class=w>       </span><span class=m>0</span>.73<span class=w>      </span><span class=m>0</span>.75<span class=w>      </span><span class=m>0</span>.73<span class=w>        </span><span class=m>80</span>
</span></code></pre></div><hr><h2>代码仓库</h2><p><a href=https://github.com/RonaldLN/NPUCM24>RonaldLN/NPUCM24</a><hr><div class=md-source-file><small> 最后更新: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class=timeago datetime=2024-05-09T09:34:42+00:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2024-05-09</span> <br> 创建日期: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class=timeago datetime=2024-05-02T03:05:42+00:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2024-05-02</span> </small></div><h2 id=__comments>评论</h2><script async crossorigin data-category=Announcements data-category-id=DIC_kwDOKTCz0s4CZ2M5 data-emit-metadata=1 data-input-position=top data-lang=zh-CN data-loading=lazy data-mapping=pathname data-reactions-enabled=1 data-repo=RonaldLN/MyPamphlet-Blog data-repo-id=R_kgDOKTCz0g data-strict=0 data-theme=https://cdn.jsdelivr.net/gh/RonaldLN/MyPamphlet-Blog@main/docs/stylesheets/giscus_sunset_glow.css src=https://giscus.app/client.js></script><script>var giscus = document.querySelector("script[src*=giscus]")

    // Set palette on initial load
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "sunset-glow-dark"
        ? "https://cdn.jsdelivr.net/gh/RonaldLN/MyPamphlet-Blog@main/docs/stylesheets/giscus_sunset_glow_dark.css"
        : "https://cdn.jsdelivr.net/gh/RonaldLN/MyPamphlet-Blog@main/docs/stylesheets/giscus_sunset_glow.css"

      // Instruct Giscus to set theme
      giscus.setAttribute("data-theme", theme) 
    }

    // Register event handlers after documented loaded
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "sunset-glow-dark"
            ? "https://cdn.jsdelivr.net/gh/RonaldLN/MyPamphlet-Blog@main/docs/stylesheets/giscus_sunset_glow_dark.css"
            : "https://cdn.jsdelivr.net/gh/RonaldLN/MyPamphlet-Blog@main/docs/stylesheets/giscus_sunset_glow.css"

          // Instruct Giscus to change theme
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })</script></article></div></div><button class="md-top md-icon" data-md-component=top hidden type=button><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> 回到页面顶部</button></main><footer class=md-footer><nav class="md-footer__inner md-grid" aria-label=页脚><a aria-label="上一页: 尝试本地部署大模型(Llama 3)" class="md-footer__link md-footer__link--prev" href=../../../04/29/llama-3/> <div class="md-footer__button md-icon"><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg></div> <div class=md-footer__title><span class=md-footer__direction> 上一页 </span><div class=md-ellipsis>尝试本地部署大模型(Llama 3)</div></div> </a><a aria-label="下一页: 使用百度AI的api" class="md-footer__link md-footer__link--next" href=../../04/aiapi/> <div class=md-footer__title><span class=md-footer__direction> 下一页 </span><div class=md-ellipsis>使用百度AI的api</div></div> <div class="md-footer__button md-icon"><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg></div> </a></nav><div class="md-footer-meta md-typeset"><div class="md-footer-meta__inner md-grid"><div class=md-copyright><div class=md-copyright__highlight>Copyright © 2023 - 2025 Ronald Luo</div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ rel=noopener target=_blank> Material for MkDocs </a></div></div></div></footer></div><div class=md-dialog data-md-component=dialog><div class="md-dialog__inner md-typeset"></div></div><div class=md-progress data-md-component=progress role=progressbar></div><script id=__config type=application/json>{"base": "../../../..", "features": ["navigation.expand", "toc.follow", "navigation.top", "search.suggest", "navigation.footer", "navigation.tabs", "navigation.tracking", "navigation.instant", "navigation.instant.progress", "content.code.copy", "search.suggest", "search.highlight", "search.share"], "search": "../../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script><script src=../../../../assets/javascripts/bundle.aecac24b.min.js></script><script src=../../../../js/timeago.min.js></script><script src=../../../../js/timeago_mkdocs_material.js></script><script src=../../../../javascripts/katex.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/contrib/auto-render.min.js></script><script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script>